<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Contract Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Google Fonts import - must be at the top */
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600&family=Roboto:wght@300;400;500&display=swap');
        
        /* Google Material Design theme colors */
        :root {
            --google-blue: #4285f4;
            --google-red: #ea4335;
            --google-yellow: #fbbc04;
            --google-green: #34a853;
            --google-blue-dark: #3367d6;
            --google-red-dark: #d33b2c;
            --google-yellow-dark: #f9ab00;
            --google-green-dark: #2e7d32;
            --google-gray: #9aa0a6;
            --google-light-gray: #f8f9fa;
            --google-dark-gray: #5f6368;
        }

        .btn-outline-indigo {
            color: var(--google-blue);
            border-color: var(--google-blue);
        }
        .btn-outline-indigo:hover {
            color: #fff;
            background-color: var(--google-blue);
            border-color: var(--google-blue);
        }
        .btn-outline-indigo:focus {
            box-shadow: 0 0 0 0.2rem rgba(66, 133, 244, 0.25);
        }
        .btn-outline-indigo.active,
        .btn-outline-indigo:active {
            color: #fff;
            background-color: var(--google-blue);
            border-color: var(--google-blue);
        }

        /* Override Bootstrap primary color with Google blue theme */
        .btn-primary {
            background-color: var(--google-blue) !important;
            border-color: var(--google-blue) !important;
            font-weight: 500 !important;
            letter-spacing: 0.5px !important;
        }
        .btn-primary:hover {
            background-color: var(--google-blue-dark) !important;
            border-color: var(--google-blue-dark) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3) !important;
        }
        .btn-outline-primary {
            color: var(--google-blue) !important;
            border-color: var(--google-blue) !important;
            font-weight: 500 !important;
        }
        .btn-outline-primary:hover {
            background-color: var(--google-blue) !important;
            border-color: var(--google-blue) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(66, 133, 244, 0.2) !important;
        }
        .text-primary {
            color: var(--google-blue) !important;
        }
        .bg-primary {
            background-color: var(--google-blue) !important;
        }
        .bg-gradient.bg-primary {
            background: linear-gradient(135deg, var(--google-blue) 0%, var(--google-blue-dark) 100%) !important;
        }
        .card-header.bg-primary {
            background: linear-gradient(135deg, var(--google-blue) 0%, var(--google-blue-dark) 100%) !important;
        }

        /* Google-style cards with Material Design shadows */
        .card {
            border: none !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
            transition: all 0.3s ease !important;
        }
        .card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
            transform: translateY(-2px) !important;
        }

        /* Google-style form controls */
        .form-control, .form-select {
            border: 2px solid #e8eaed !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--google-blue) !important;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1) !important;
            outline: none !important;
        }

        /* Google-style labels */
        .form-label {
            font-weight: 500 !important;
            color: var(--google-dark-gray) !important;
            font-size: 14px !important;
            margin-bottom: 8px !important;
        }

        /* Analytics Column Styles */
        #toggleAnalytics {
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            background-color: var(--google-blue) !important;
            border-color: var(--google-blue) !important;
        }

        #toggleAnalytics:hover {
            background-color: var(--google-blue-dark) !important;
            border-color: var(--google-blue-dark) !important;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4) !important;
        }

        /* Full height layout with Google-style background */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on the entire page */
            background-color: var(--google-light-gray); /* Google light background */
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }

        #mainContainer {
            height: 100vh;
            padding: 0 !important;
            overflow: hidden; /* Prevent scrolling on main container */
            background-color: var(--google-light-gray); /* Google light background */
        }

        #analyticsColumn {
            height: calc(100vh - 90px); /* Full height minus header */
            margin-bottom: 0 !important;
            padding: 20px 20px 20px 20px; /* Restore bottom padding for proper spacing */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent scrolling in analytics column */
        }

        #analyticsColumn .card {
            height: calc(100vh - 130px); /* Full height minus header and padding */
            border-radius: 1.5rem !important;
            width: 100%;
            flex: none; /* Don't flex, use fixed height */
            overflow: hidden; /* Prevent card overflow */
        }

        #analyticsColumn .card-header {
            border-radius: 1.5rem 1.5rem 0 0 !important;
        }

        #analyticsColumn .card-body {
            border-radius: 0 0 1.5rem 1.5rem !important;
            height: calc(100vh - 200px); /* Fixed height calculation */
            overflow: hidden; /* Prevent scrolling */
            display: flex;
            flex-direction: column;
        }

        #mainContentColumn {
            height: calc(100vh - 90px); /* Subtract header height */
            overflow: hidden; /* Prevent column from scrolling */
            padding: 0; /* Remove padding to manage it internally */
            display: flex;
            flex-direction: column;
        }

        /* Loading animation for milestone status */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ensure milestone loading spinners animate properly */
        .milestone-loading-spinner {
            animation: spin 1s linear infinite;
        }

        /* Tag loading spinner animation */
        .tag-loading-spinner {
            animation: spin 1s linear infinite;
        }

        /* Refresh button spinner animation */
        .spin {
            animation: spin 1s linear infinite;
        }

        /* Analytics dashboard content styling */
        #analyticsContent {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden; /* Prevent any scrolling */
            max-height: 100%; /* Ensure it doesn't exceed container */
        }

        #analyticsContent .mb-3:not(:last-child) {
            flex-shrink: 0; /* Don't shrink the form elements */
        }

        #analyticsContent .mb-3:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden; /* Prevent chart area from overflowing */
        }

        #analyticsContent .mb-3:last-child > div:first-child {
            flex-shrink: 0;
        }

        #analyticsContent .mb-3:last-child > div:last-child {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Constrain chart container */
        #analyticsContent .mb-3:last-child > div:last-child > div {
            height: 100% !important;
            max-height: 100% !important;
            overflow: hidden !important;
        }

        /* Google-style interactions */
        .color-option:hover {
            transform: scale(1.1) !important;
            border: 3px solid var(--google-blue) !important;
        }

        .color-option.selected {
            border: 3px solid var(--google-blue) !important;
            transform: scale(1.05) !important;
        }

        /* Google-style button animations */
        .btn {
            transition: all 0.2s ease !important;
        }

        .btn:not(.btn-primary):not(.btn-secondary):not(.btn-danger):hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        /* Google-style input focus animations */
        .form-control:focus, .form-select:focus {
            transform: translateY(-1px) !important;
        }

        /* Google-style stat cards */
        .bg-primary.bg-opacity-10 {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.1) 0%, rgba(66, 133, 244, 0.05) 100%) !important;
            border: 1px solid rgba(66, 133, 244, 0.2) !important;
            transition: all 0.2s ease !important;
        }

        .bg-primary.bg-opacity-10:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.2) !important;
        }
    </style>
</head>
<body>

    <div class="container-fluid" id="mainContainer">
        <!-- Main Application Title with Logo - Google Style -->
        <div class="row" style="background: linear-gradient(135deg, var(--google-blue) 0%, var(--google-blue-dark) 100%); padding: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="col-12 d-flex align-items-center justify-content-center" style="position: relative;">
                <!-- Logo positioned in top left -->
                <img src="https://10starshomes.com/wp-content/uploads/2020/09/apple.png" 
                     alt="10 Stars Homes Logo" 
                     style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); height: 45px; width: auto; filter: brightness(0) invert(1);">
                <!-- Centered title with Google typography -->
                <h1 class="fw-normal text-white" style="letter-spacing: 0.5px; margin-bottom: 0; font-size: 28px; font-weight: 400;">Company Contract Tracker</h1>
                <!-- Settings dropdown with gear icon -->
                <div class="dropdown" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); z-index: 99999;">
                    <button class="btn btn-link text-white p-0" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="border: none; background: none; font-size: 24px;">
                        <i class="bi bi-gear" style="filter: brightness(0) invert(1);"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="settingsDropdown" style="border-radius: 12px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 99999;">
                        <li>
                            <a class="dropdown-item" href="#" id="openEmailTemplates" style="padding: 12px 20px; font-weight: 500;">
                                <i class="bi bi-envelope-plus me-2 text-primary"></i>Email Templates
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" id="openInternalEmailTemplates" style="padding: 12px 20px; font-weight: 500;">
                                <i class="bi bi-envelope-at me-2 text-warning"></i>Internal Email Templates
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="row h-100">
            <!-- Analytics Dashboard - Left Half -->
            <div class="col-lg-6" id="analyticsColumn">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 16px !important; overflow: hidden;">
                    <div class="card-header bg-gradient text-white border-0" style="background: linear-gradient(135deg, var(--google-blue) 0%, var(--google-blue-dark) 100%) !important; padding: 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-white" style="font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                <span style="background: var(--google-green); padding: 6px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; font-size: 14px;">📊</span>
                                Analytics Dashboard
                            </h5>
                        </div>
                    </div>
                    <div class="card-body bg-white" id="analyticsContent" style="padding: 24px;">
                        <!-- Chart Type Selector -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-primary">📈 Chart Type</label>
                            <select class="form-select form-select-sm rounded-3" id="chartTypeSelector">
                                <option value="companyStatus">Company Status Comparison</option>
                                <option value="milestoneProgress">Milestone Progress Overview</option>
                                <option value="completionTrends">Completion Trends</option>
                                <option value="bottleneckAnalysis">Bottleneck Analysis</option>
                            </select>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-semibold text-primary">📅 Period</label>
                                <select class="form-select form-select-sm rounded-3" id="timePeriodSelector">
                                    <option value="all">All Time</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="today">Today</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-semibold text-primary">🏢 Company</label>
                                <select class="form-select form-select-sm rounded-3" id="companyFilter">
                                    <option value="all">All Projects</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-sm w-100 mb-3 rounded-3" id="refreshCharts">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Charts
                        </button>

                        <!-- Main Chart Display -->
                        <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <div class="fw-bold text-primary mb-2" id="currentChartTitle">🏢 Company Status Comparison</div>
                            <div style="position: relative; flex: 1; min-height: 0; overflow: hidden;">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Company Contract Tracker - Right Half -->
            <div class="col-lg-6" id="mainContentColumn">
                
                <!-- Fixed header section with padding -->
                <div style="flex-shrink: 0; padding: 20px 24px 0 24px;">
                    <!-- Google Sheets Configuration Alert -->
                    <div class="alert alert-warning alert-dismissible fade show" id="sheetsAlert" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Database Configuration:</strong> 
                                <span id="sheetsStatus">Checking Google Sheets connection...</span>
                                <div class="mt-1">
                                    <small class="text-muted" id="cacheStatus"></small>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-info" id="refreshData" style="display: none;">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="configureSheets">Configure Google Sheets</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="useLocalStorage">Use Local Storage</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scrollable company list section -->
                <div style="flex: 1; overflow-y: auto; padding: 20px 24px 0 24px;">
                    <!-- Company List -->
                    <div class="card shadow-sm border-0 mb-4" style="border-radius: 16px !important; overflow: hidden;">
                        <div class="card-header bg-gradient text-white border-0" style="background: linear-gradient(135deg, var(--google-red) 0%, var(--google-red-dark) 100%) !important; padding: 12px;">
                            <h5 class="mb-0 text-white" style="font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                <span style="background: var(--google-yellow); padding: 6px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; color: var(--google-dark-gray); font-size: 14px;">📋</span>
                                Projects
                            </h5>
                        </div>
                        <div class="card-body bg-white" style="padding: 24px;">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-2">
                                    <input type="text" class="form-control rounded-3" id="searchCompany" placeholder="Search projects...">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <select class="form-select rounded-3" id="searchFilter">
                                        <option value="all">Search All Fields</option>
                                        <option value="address">Address Only</option>
                                        <option value="contactName">Contact Name Only</option>
                                        <option value="contactEmail">Email Only</option>
                                        <option value="createdDate">Date Only</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <select class="form-select rounded-3" id="sortBy">
                                        <option value="newest">Newest First</option>
                                        <option value="oldest">Oldest First</option>
                                        <option value="address">Address A-Z</option>
                                        <option value="contactName">Contact Name A-Z</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0 rounded-start-3">
                                            <i class="bi bi-calendar3"></i>
                                        </span>
                                        <input type="date" class="form-control border-start-0 rounded-end-3" id="dateFrom" placeholder="From Date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0 rounded-start-3">
                                            <i class="bi bi-calendar3"></i>
                                        </span>
                                        <input type="date" class="form-control border-start-0 rounded-end-3" id="dateTo" placeholder="To Date">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12 d-flex justify-content-between align-items-center">
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="clearFilters">
                                            <i class="bi bi-x-circle"></i> Clear Filters
                                        </button>
                                        <span class="text-muted small" id="resultsCount">Showing all projects</span>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm" id="addNewProjectBtn">
                                        <i class="bi bi-plus-circle"></i> Add New Project
                                    </button>
                                </div>
                            </div>
                            <div id="companiesList" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Milestone Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 16px !important; border: none; overflow: hidden;">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, var(--google-blue) 0%, var(--google-blue-dark) 100%) !important; padding: 16px;">
                    <h5 class="modal-title text-white" style="font-weight: 500;">Notes for <span id="milestoneName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-white" style="padding: 24px;">
                    <div id="existingNotes"></div>
                    <textarea class="form-control mt-3" id="newNote" rows="3" placeholder="Add a new note..." style="border-radius: 12px !important;"></textarea>
                </div>
                <div class="modal-footer bg-white border-0" style="padding: 24px; gap: 12px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNote" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Milestone Tag Modal -->
    <div class="modal fade" id="tagModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 16px !important; border: none; overflow: hidden;">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, var(--google-green) 0%, var(--google-green-dark) 100%) !important; padding: 16px;">
                    <h5 class="modal-title text-white" style="font-weight: 500;">Tag Options</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-white" style="padding: 24px;">
                    <div class="mb-3">
                        <label for="tagInput" class="form-label fw-semibold text-dark">Tag Text</label>
                        <input type="text" class="form-control" id="tagInput" placeholder="Enter custom tag..." style="border-radius: 12px !important;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-dark">Tag Color</label>
                        <div class="d-flex flex-wrap gap-3" id="colorOptions" style="margin-top: 12px;">
                            <button type="button" class="btn color-option" data-color="primary" style="background-color: var(--google-blue); width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="success" style="background-color: var(--google-green); width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="danger" style="background-color: var(--google-red); width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="warning" style="background-color: var(--google-yellow); width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="info" style="background-color: #0dcaf0; width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="secondary" style="background-color: var(--google-gray); width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="dark" style="background-color: var(--google-dark-gray); width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                            <button type="button" class="btn color-option" data-color="indigo" style="background-color: #6610f2; width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease;"></button>
                        </div>
                        <input type="hidden" id="selectedColor" value="secondary">
                    </div>
                </div>
                <div class="modal-footer bg-white border-0" style="padding: 24px; gap: 12px;">
                    <button type="button" class="btn btn-danger" id="deleteTag" style="display:none; border-radius: 24px; padding: 12px 24px; font-weight: 500;">Delete Tag</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTag" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Save Tag</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Tag Input Modal -->
    <div class="modal fade" id="quickTagInputModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quickTagModalLabel">Add Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quickTagInput" class="form-label">Tag Text</label>
                        <input type="text" class="form-control" id="quickTagInput" placeholder="Enter tag text" maxlength="20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tag Color</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn quick-color-option" data-color="primary" style="background-color: #0d6efd; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent;"></button>
                            <button type="button" class="btn quick-color-option" data-color="secondary" style="background-color: #6c757d; width: 32px; height: 32px; border-radius: 50%; border: 2px solid #000;"></button>
                            <button type="button" class="btn quick-color-option" data-color="success" style="background-color: #198754; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent;"></button>
                            <button type="button" class="btn quick-color-option" data-color="danger" style="background-color: #dc3545; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent;"></button>
                            <button type="button" class="btn quick-color-option" data-color="warning" style="background-color: #ffc107; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent;"></button>
                            <button type="button" class="btn quick-color-option" data-color="info" style="background-color: #0dcaf0; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent;"></button>
                            <button type="button" class="btn quick-color-option" data-color="dark" style="background-color: #212529; width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent;"></button>
                        </div>
                        <input type="hidden" id="quickSelectedColor" value="secondary">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveQuickTag">Add Tag</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 16px !important; border: none; overflow: hidden;">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, var(--google-green) 0%, var(--google-green-dark) 100%) !important; padding: 16px;">
                    <h5 class="modal-title text-white" style="font-weight: 500;">🏢 Add New Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-white" style="padding: 24px;">
                    <form id="addProjectModalForm">
                        <div class="mb-3">
                            <label for="modalContactName" class="form-label fw-semibold text-primary">Contact Name</label>
                            <input type="text" class="form-control rounded-3" id="modalContactName" placeholder="Enter contact name" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalCreatedDate" class="form-label fw-semibold text-primary">Project Created Date</label>
                            <input type="date" class="form-control rounded-3" id="modalCreatedDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalAddress" class="form-label fw-semibold text-primary">Address</label>
                            <input type="text" class="form-control rounded-3" id="modalAddress" placeholder="Enter project address" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalContactEmail" class="form-label fw-semibold text-primary">Contact Email</label>
                            <input type="email" class="form-control rounded-3" id="modalContactEmail" placeholder="Enter contact email" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-white border-0" style="padding: 24px; gap: 12px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewProject" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Add Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Sheets Configuration Modal -->
    <div class="modal fade" id="sheetsConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 16px !important; border: none; overflow: hidden;">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, var(--google-red) 0%, var(--google-red-dark) 100%) !important; padding: 16px;">
                    <h5 class="modal-title text-white" style="font-weight: 500;">Configure Google Sheets Database</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-white" style="padding: 24px;">
                    <div class="alert alert-info">
                        <strong>Instructions:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Create a Google Sheet and copy its ID from the URL</li>
                            <li>Create a Google Cloud Project and enable the Sheets API</li>
                            <li>Create a Service Account and download the JSON credentials</li>
                            <li>Share your Google Sheet with the service account email</li>
                            <li>Paste the credentials and sheet ID below</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <label for="spreadsheetId" class="form-label fw-semibold">Google Sheet ID</label>
                        <input type="text" class="form-control rounded-3" id="spreadsheetId" 
                               placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" 
                               title="Found in the Google Sheets URL between /spreadsheets/d/ and /edit">
                        <small class="text-muted">Copy from your Google Sheets URL: https://docs.google.com/spreadsheets/d/<strong>YOUR_SHEET_ID</strong>/edit</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="credentialsFile" class="form-label fw-semibold">Service Account Credentials (JSON)</label>
                        <textarea class="form-control rounded-3" id="credentialsFile" rows="8" 
                                  placeholder="Paste your service account JSON credentials here..."></textarea>
                        <small class="text-muted">This should start with {"type": "service_account", ...}</small>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-info btn-sm" id="showSetupGuide">
                            <i class="bi bi-question-circle"></i> Show Detailed Setup Guide
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm ms-2" id="resetConfig">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset Configuration
                        </button>
                    </div>
                    
                    <div class="collapse" id="setupGuide">
                        <div class="card">
                            <div class="card-body">
                                <h6>Detailed Setup Instructions:</h6>
                                <ol>
                                    <li><strong>Create Google Sheet:</strong> Go to <a href="https://sheets.google.com" target="_blank">sheets.google.com</a> and create a new sheet</li>
                                    <li><strong>Get Sheet ID:</strong> Copy the long ID from the URL (between /d/ and /edit)</li>
                                    <li><strong>Google Cloud Console:</strong> Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a></li>
                                    <li><strong>Create Project:</strong> Create a new project or select existing one</li>
                                    <li><strong>Enable Sheets API:</strong> Go to "APIs & Services" → "Library" → Search "Google Sheets API" → Enable it</li>
                                    <li><strong>Create Service Account:</strong> Go to "APIs & Services" → "Credentials" → "Create Credentials" → "Service Account"</li>
                                    <li><strong>Download JSON:</strong> Click on the service account → "Keys" → "Add Key" → "Create New Key" → JSON</li>
                                    <li><strong>Share Sheet:</strong> Copy the service account email from the JSON file and share your Google Sheet with it (Editor access)</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-white border-0" style="padding: 24px; gap: 12px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSheetConfig" style="border-radius: 24px; padding: 12px 24px; font-weight: 500;">Connect to Google Sheets</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Templates Modal -->
    <div class="modal fade" id="emailTemplatesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="border-radius: 16px !important; border: none; overflow: hidden;">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%) !important; padding: 16px;">
                    <h5 class="modal-title text-white" style="font-weight: 500;">📧 Email Templates Management</h5>
                    <button type="button" class="btn btn-link text-white p-0" data-bs-dismiss="modal" aria-label="Close" style="border: none; background: none; font-size: 24px; color: white !important; text-decoration: none;">
                        <i class="bi bi-x-lg" style="color: white !important;"></i>
                    </button>
                </div>
                <div class="modal-body bg-white" style="padding: 24px;">
                    <div class="row">
                        <!-- Templates List -->
                        <div class="col-md-4">
                            <h6 class="fw-bold mb-3" style="color: #1976d2;">📧 Templates</h6>
                            
                            <!-- Search Input -->
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 rounded-start-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0 rounded-end-3" id="templateSearch" placeholder="Search templates..." style="box-shadow: none; border-color: #dee2e6;">
                                </div>
                            </div>
                            
                            <div class="list-group" id="templatesList">
                                <!-- Templates will be loaded here -->
                            </div>
                            <button class="btn btn-sm w-100 mt-3" id="resetToDefaults" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); border: none; color: white;">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Default Templates
                            </button>
                        </div>
                        
                        <!-- Template Editor -->
                        <div class="col-md-8">
                            <div id="templateEditor" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0" style="color: #1976d2;">✏️ Edit Template</h6>
                                    <button type="button" class="btn-close" id="closeTemplateEditor" aria-label="Close"></button>
                                </div>
                                <form id="templateForm">
                                    <div class="mb-3">
                                        <label for="templateName" class="form-label fw-semibold">Template Name</label>
                                        <input type="text" class="form-control rounded-3" id="templateName" name="templateName" placeholder="e.g., Keys Milestone Complete" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="templateMilestone" class="form-label fw-semibold">Associated Milestone</label>
                                        <select class="form-select rounded-3" id="templateMilestone" name="templateMilestone">
                                            <option value="">Select Milestone (Optional)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="templateType" class="form-label fw-semibold">Template Type</label>
                                        <select class="form-select rounded-3" id="templateType" name="templateType" required>
                                            <option value="external">External (Client Communication)</option>
                                            <option value="internal">Internal (Team Communication)</option>
                                        </select>
                                        <small class="text-muted">External templates are used for client communication, Internal templates are for team notifications</small>
                                    </div>
                                    
                                    <div class="mb-3" id="internalEmailField" style="display: none;">
                                        <label for="templateInternalEmail" class="form-label fw-semibold">Internal Email Address</label>
                                        <input type="email" class="form-control rounded-3" id="templateInternalEmail" name="templateInternalEmail" placeholder="team@company.com">
                                        <small class="text-muted">Default email address for internal notifications (optional - will prompt if not set)</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="templateSubject" class="form-label fw-semibold">Email Subject</label>
                                        <input type="text" class="form-control rounded-3" id="templateSubject" name="templateSubject" placeholder="Subject line..." required>
                                        <small class="text-muted">Available variables: {contactName}, {contactEmail}, {address}, {milestoneName}, {currentDate}, {currentTime}, {currentDateTime}, {milestoneCompletedDate}, {milestoneCompletedTime}, {milestoneCompletedDateTime}, {projectCreatedDate}, {daysSinceStart}, {companyName}, {companyId}</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="templateBody" class="form-label fw-semibold">Email Body</label>
                                        <textarea class="form-control rounded-3" id="templateBody" name="templateBody" rows="8" placeholder="Email content..." required></textarea>
                                        <small class="text-muted">Available variables: {contactName}, {contactEmail}, {address}, {milestoneName}, {currentDate}, {currentTime}, {currentDateTime}, {milestoneCompletedDate}, {milestoneCompletedTime}, {milestoneCompletedDateTime}, {projectCreatedDate}, {daysSinceStart}, {companyName}, {companyId}</small>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); border: none;">Save Template</button>
                                        <button type="button" class="btn btn-outline-primary" id="previewTemplate">Preview</button>
                                        <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Welcome Message -->
                            <div id="welcomeMessage" class="text-center text-muted">
                                <i class="bi bi-envelope-plus" style="font-size: 3rem; color: #1976d2;"></i>
                                <h5 class="mt-3">Email Templates</h5>
                                <p>Create and manage email templates for different milestones.<br>Select a template from the list or create a new one.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Internal Email Templates Modal -->
    <div class="modal fade" id="internalEmailTemplatesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="border-radius: 16px !important; border: none; overflow: hidden;">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important; padding: 16px;">
                    <h5 class="modal-title text-white" style="font-weight: 500;">Internal Email Templates Management</h5>
                    <button type="button" class="btn btn-link text-white p-0" data-bs-dismiss="modal" aria-label="Close" style="border: none; background: none; font-size: 24px; color: white !important; text-decoration: none;">
                        <i class="bi bi-x-lg" style="color: white !important;"></i>
                    </button>
                </div>
                <div class="modal-body bg-white" style="padding: 24px;">
                    <div class="row">
                        <!-- Internal Templates List -->
                        <div class="col-md-4">
                            <h6 class="fw-bold text-warning mb-3">📨 Internal Templates</h6>
                            
                            <!-- Search Input -->
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 rounded-start-3">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0 rounded-end-3" id="internalTemplateSearch" placeholder="Search internal templates..." style="box-shadow: none; border-color: #dee2e6;">
                                </div>
                            </div>
                            
                            <div class="list-group" id="internalTemplatesList">
                                <!-- Internal templates will be loaded here -->
                            </div>
                            <button class="btn btn-warning btn-sm w-100 mt-3" id="addNewInternalTemplate" style="display: none;">
                                <i class="bi bi-plus-circle"></i> Add New Internal Template
                            </button>
                            <button class="btn btn-sm w-100 mt-3" id="resetInternalToDefaults" style="background: linear-gradient(135deg, #ff9800 0%, #f57400 100%); border: none; color: white;">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Default Internal Templates
                            </button>
                        </div>
                        
                        <!-- Internal Template Editor -->
                        <div class="col-md-8">
                            <div id="internalTemplateEditor" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold text-warning mb-0">✏️ Edit Internal Template</h6>
                                    <button type="button" class="btn-close" id="closeInternalTemplateEditor" aria-label="Close"></button>
                                </div>
                                <form id="internalTemplateForm">
                                    <div class="mb-3">
                                        <label for="internalTemplateName" class="form-label fw-semibold">Template Name</label>
                                        <input type="text" class="form-control rounded-3" id="internalTemplateName" name="internalTemplateName" placeholder="e.g., Keys Ready - Internal Notification" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="internalTemplateMilestone" class="form-label fw-semibold">Associated Milestone</label>
                                        <select class="form-select rounded-3" id="internalTemplateMilestone" name="internalTemplateMilestone">
                                            <option value="">Select Milestone (Optional)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="internalTemplateEmail" class="form-label fw-semibold">Default Internal Email Address</label>
                                        <input type="email" class="form-control rounded-3" id="internalTemplateEmail" name="internalTemplateEmail" placeholder="team@company.com, manager@company.com">
                                        <small class="text-muted">Default email address(es) for this template. You can edit this when sending.</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="internalTemplateSubject" class="form-label fw-semibold">Email Subject</label>
                                        <input type="text" class="form-control rounded-3" id="internalTemplateSubject" name="internalTemplateSubject" placeholder="Internal Update: {milestoneName} - {address}" required>
                                        <small class="text-muted">Available variables: {contactName}, {contactEmail}, {address}, {milestoneName}, {currentDate}, {currentTime}, {currentDateTime}, {milestoneCompletedDate}, {milestoneCompletedTime}, {milestoneCompletedDateTime}, {projectCreatedDate}, {daysSinceStart}, {companyName}, {companyId}</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="internalTemplateBody" class="form-label fw-semibold">Email Body</label>
                                        <textarea class="form-control rounded-3" id="internalTemplateBody" name="internalTemplateBody" rows="8" placeholder="Internal email content..." required></textarea>
                                        <small class="text-muted">Available variables: {contactName}, {contactEmail}, {address}, {milestoneName}, {currentDate}, {currentTime}, {currentDateTime}, {milestoneCompletedDate}, {milestoneCompletedTime}, {milestoneCompletedDateTime}, {projectCreatedDate}, {daysSinceStart}, {companyName}, {companyId}</small>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-warning">Save Internal Template</button>
                                        <button type="button" class="btn btn-outline-warning" id="previewInternalTemplate">Preview</button>
                                        <button type="button" class="btn btn-secondary" id="cancelInternalEdit">Cancel</button>
                                        <button type="button" class="btn btn-outline-danger" id="deleteInternalTemplate" style="display: none;">Delete Template</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Welcome Message -->
                            <div id="internalWelcomeMessage" class="text-center text-muted">
                                <i class="bi bi-envelope-at" style="font-size: 3rem; color: #ff9800;"></i>
                                <h5 class="mt-3">Internal Email Templates</h5>
                                <p>View and edit internal email templates for team notifications.<br>Select a template from the list to view details.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        let currentSearchTerm = ''; // Track the current search term
        
        // Track minimized state for each company
        const minimizedMilestones = {};
        let minimizedCompanies = {};

        // Global state manager to prevent race conditions
        let globalCompaniesData = [];
        let isLoadingData = false;
        let saveTimeout = null;
        let isSaving = false;

        async function loadGlobalData() {
            if (isLoadingData) {
                return globalCompaniesData;
            }
            
            isLoadingData = true;
            try {
                globalCompaniesData = await window.electronAPI.getCompanies();
                return globalCompaniesData;
            } catch (error) {
                console.error('loadGlobalData: Failed to load company data:', error.message);
                throw error;
            } finally {
                isLoadingData = false;
            }
        }

        function updateMilestone(companyId, milestoneId, updates) {
            const company = globalCompaniesData.find(c => c.id == companyId);
            if (!company || !company.milestones) {
                console.error('updateMilestone: Company or milestones not found for update');
                return false;
            }
            
            const milestone = company.milestones.find(m => m.id == milestoneId);
            if (!milestone) {
                console.error('updateMilestone: Milestone not found for update');
                return false;
            }
            
            Object.assign(milestone, updates);
            
            // Schedule save
            scheduleSave();
            return true;
        }

        function scheduleSave() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            saveTimeout = setTimeout(async () => {
                if (isSaving) {
                    return;
                }
                
                try {
                    isSaving = true;
                    await window.electronAPI.saveCompanies(globalCompaniesData);
                    document.dispatchEvent(new CustomEvent('dataSaved', { detail: { success: true } }));
                } catch (error) {
                    console.error('scheduleSave: Save operation failed:', error.message);
                    document.dispatchEvent(new CustomEvent('dataSaved', { detail: { success: false, error } }));
                } finally {
                    isSaving = false;
                }
            }, 1000);
        }

        // Charts functionality
        let currentChart = null;
        let chartsData = {};

        // Initialize charts functionality
        function initializeCharts() {
            // Chart type change
            document.getElementById('chartTypeSelector').addEventListener('change', function() {
                updateChartTitle();
                updateCharts();
            });

            // Filter changes
            document.getElementById('timePeriodSelector').addEventListener('change', function() {
                updateChartTitle();
                // Use stored company data to avoid unnecessary API calls
                chartsData = processChartData(chartsData.allCompanies || []);
                renderCurrentChart();
            });
            document.getElementById('companyFilter').addEventListener('change', function() {
                updateChartTitle();
                // Don't rebuild company filter, just update charts with current data
                chartsData = processChartData(chartsData.allCompanies || []);
                renderCurrentChart();
            });
            document.getElementById('refreshCharts').addEventListener('click', updateCharts);
            
            // Initialize charts on page load
            updateCharts();
        }

        function updateChartTitle() {
            const chartType = document.getElementById('chartTypeSelector').value;
            const timePeriod = document.getElementById('timePeriodSelector').value;
            const companyFilter = document.getElementById('companyFilter').value;
            const titleElement = document.getElementById('currentChartTitle');
            
            const baseTitle = {
                milestoneProgress: '📊 Milestone Progress Overview',
                companyStatus: '🏢 Company Status Comparison',
                completionTrends: '📈 Completion Trends',
                bottleneckAnalysis: '🔍 Bottleneck Analysis'
            };
            
            let title = baseTitle[chartType] || 'Analytics Chart';
            
            // Add filter context
            const filters = [];
            
            if (timePeriod && timePeriod !== 'all') {
                const periodText = {
                    'today': 'Today',
                    '7days': 'Last 7 Days',
                    '30days': 'Last 30 Days'
                };
                filters.push(periodText[timePeriod]);
            }
            
            if (companyFilter && companyFilter !== 'all') {
                // Get company name
                const companySelect = document.getElementById('companyFilter');
                const selectedOption = companySelect.options[companySelect.selectedIndex];
                filters.push(selectedOption.text);
            }
            
            if (filters.length > 0) {
                title += ` (${filters.join(', ')})`;
            }
            
            titleElement.textContent = title;
        }

        async function updateCharts() {
            try {
                // Use global data if available and avoid loading fresh data if we're in the middle of saving
                let companies;
                if (globalCompaniesData.length > 0 && (isSaving || saveTimeout)) {
                    // Use current global state to avoid overwriting pending changes
                    companies = globalCompaniesData;
                } else {
                    // Safe to load fresh data
                    companies = await loadGlobalData();
                }
                
                // Store original companies data for filter operations
                chartsData = processChartData(companies);
                chartsData.allCompanies = companies; // Store original data
                updateCompanyFilter(companies);
                updateChartTitle(); // Update title after company filter is populated
                renderCurrentChart();
            } catch (error) {
                console.error('Error updating charts:', error);
                // Don't crash the app, just show error in chart area
                const chartTitle = document.getElementById('currentChartTitle');
                if (chartTitle) {
                    chartTitle.textContent = 'Error loading chart data';
                }
            }
        }

        function processChartData(companies) {
            // Get filter values
            const timePeriod = document.getElementById('timePeriodSelector').value;
            const companyFilterValue = document.getElementById('companyFilter').value;
            
            // Apply company filter
            let filteredCompanies = companies;
            if (companyFilterValue && companyFilterValue !== 'all') {
                filteredCompanies = companies.filter(company => company.id == companyFilterValue);
            }
            
            // Apply time period filter
            const now = new Date();
            const today = now.toISOString().slice(0, 10);
            let startDate = null;
            
            switch (timePeriod) {
                case 'today':
                    startDate = today;
                    break;
                case '7days':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    startDate = weekAgo.toISOString().slice(0, 10);
                    break;
                case '30days':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    startDate = monthAgo.toISOString().slice(0, 10);
                    break;
                case 'all':
                default:
                    startDate = null;
                    break;
            }

            const data = {
                companies: filteredCompanies,
                totalCompanies: filteredCompanies.length,
                totalMilestones: 0,
                completedMilestones: 0,
                milestoneStats: {},
                companyStats: [],
                completionsByDate: {}
            };

            const milestoneNames = [
                'Keys', 'Power', 'Water', 'Deposit held', 'Balance', 'Move-out',
                'Quote', 'Contact owner', 'Email inspection video + quote', 'Follow up date',
                'Approval', 'Funds', 'Order of materials', 'Prebill', 'Wait list',
                'Rehab start', 'Add ons', 'Rehab ends', 'Dump and pick up material left on site',
                'Vendor?', 'Cleaning', 'Quality control -final walkthrough', 'Final inspection',
                'Open recurring task lawn care', 'Move in inspection', 'Assign all rehab tasks to bill',
                'Video upload', 'Turn off utilities', 'List property', 'Billing finalized'
            ];

            // Initialize milestone stats
            milestoneNames.forEach(name => {
                data.milestoneStats[name] = { completed: 0, total: 0, percentage: 0 };
            });

            // Process each filtered company
            filteredCompanies.forEach(company => {
                if (!company.milestones) return;

                let companyCompleted = 0;
                let companyTotal = 0;

                company.milestones.forEach(milestone => {
                    // Apply time filter to milestones
                    let includeMilestone = true;
                    
                    if (startDate && milestone.completedDate) {
                        // Only include milestones completed within the time period
                        if (milestone.completed && milestone.completedDate < startDate) {
                            includeMilestone = false;
                        }
                    } else if (startDate && !milestone.completedDate && milestone.completed) {
                        // If no completion date but milestone is completed, exclude if filtering by time
                        includeMilestone = false;
                    }
                    
                    if (includeMilestone) {
                        data.totalMilestones++;
                        companyTotal++;
                        
                        // Count all milestones that exist, not just predefined ones
                        if (!data.milestoneStats[milestone.name]) {
                            data.milestoneStats[milestone.name] = { completed: 0, total: 0, percentage: 0 };
                        }
                        data.milestoneStats[milestone.name].total++;

                        if (milestone.completed) {
                            data.completedMilestones++;
                            companyCompleted++;
                            
                            data.milestoneStats[milestone.name].completed++;

                            // Track completions by date (apply time filter)
                            if (milestone.completedDate) {
                                const date = milestone.completedDate;
                                if (!startDate || date >= startDate) {
                                    if (!data.completionsByDate[date]) {
                                        data.completionsByDate[date] = 0;
                                    }
                                    data.completionsByDate[date]++;
                                }
                            }
                        }
                    }
                });

                // Calculate company completion percentage (only for filtered milestones)
                const companyPercentage = companyTotal > 0 ? (companyCompleted / companyTotal) * 100 : 0;
                data.companyStats.push({
                    name: company.address || `Company ${company.id}`,
                    completed: companyCompleted,
                    total: companyTotal,
                    percentage: companyPercentage
                });
            });

            // Calculate milestone percentages
            Object.keys(data.milestoneStats).forEach(milestoneName => {
                const stat = data.milestoneStats[milestoneName];
                stat.percentage = stat.total > 0 ? (stat.completed / stat.total) * 100 : 0;
            });

            return data;
        }

        function updateCompanyFilter(companies) {
            const filter = document.getElementById('companyFilter');
            const currentSelection = filter.value; // Save current selection
            
            // Clear existing options except "All Projects"
            filter.innerHTML = '<option value="all">All Projects</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.address || `Company ${company.id}`;
                filter.appendChild(option);
            });
            
            // Restore the previous selection if it still exists
            if (currentSelection && currentSelection !== 'all') {
                const optionExists = Array.from(filter.options).some(option => option.value === currentSelection);
                if (optionExists) {
                    filter.value = currentSelection;
                }
            }
        }

        function renderCurrentChart() {
            const chartType = document.getElementById('chartTypeSelector').value;
            const ctx = document.getElementById('mainChart').getContext('2d');

            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            switch (chartType) {
                case 'milestoneProgress':
                    renderMilestoneProgressChart(ctx);
                    break;
                case 'companyStatus':
                    renderCompanyStatusChart(ctx);
                    break;
                case 'completionTrends':
                    renderCompletionTrendsChart(ctx);
                    break;
                case 'bottleneckAnalysis':
                    renderBottleneckAnalysisChart(ctx);
                    break;
            }
        }

        function renderMilestoneProgressChart(ctx) {
            const milestoneStats = chartsData.milestoneStats;
            // Show all milestones that have data (total > 0)
            const labels = Object.keys(milestoneStats).filter(name => milestoneStats[name].total > 0);
            
            // Handle case where there's no milestone data
            if (labels.length === 0) {
                const emptyLabels = ['No data'];
                const emptyData = [0];
                const emptyColors = ['#6c757d'];
                
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: emptyLabels,
                        datasets: [{
                            label: 'Completion %',
                            data: emptyData,
                            backgroundColor: emptyColors,
                            borderColor: emptyColors,
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'No milestone data available';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 90,
                                    minRotation: 45,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
                return;
            }
            
            const data = labels.map(name => milestoneStats[name].percentage);
            const colors = labels.map((_, index) => {
                const hue = (index * 360 / labels.length) % 360;
                return `hsl(${hue}, 70%, 60%)`;
            });

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => label.length > 12 ? label.substring(0, 12) + '...' : label),
                    datasets: [{
                        label: 'Completion %',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('60%', '50%')),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const milestoneName = labels[context.dataIndex];
                                    // Get the full milestone name (not truncated)
                                    const fullMilestoneName = Object.keys(milestoneStats).find(name => 
                                        (name.length > 12 ? name.substring(0, 12) + '...' : name) === milestoneName ||
                                        name === milestoneName
                                    );
                                    const stats = milestoneStats[fullMilestoneName];
                                    return [`${fullMilestoneName}:`, `${stats.completed}/${stats.total} completed (${Math.round(context.raw)}%)`];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCompanyStatusChart(ctx) {
            const companies = chartsData.companies; // Show all companies, no limit
            
            // Get standard milestone names in order
            const standardMilestones = [
                'Keys', 'Power', 'Water', 'Deposit held', 'Balance', 'Move-out',
                'Quote', 'Contact owner', 'Email inspection video + quote', 'Follow up date',
                'Approval', 'Funds', 'Order of materials', 'Prebill', 'Wait list',
                'Rehab start', 'Add ons', 'Rehab ends', 'Dump and pick up material left on site',
                'Vendor?', 'Cleaning', 'Quality control -final walkthrough', 'Final inspection',
                'Open recurring task lawn care', 'Move in inspection', 'Assign all rehab tasks to bill',
                'Video upload', 'Turn off utilities', 'List property', 'Billing finalized'
            ];

            // Create datasets for each milestone (stacked segments)
            const datasets = standardMilestones.map((milestoneName, milestoneIndex) => {
                const data = companies.map(company => {
                    if (!company.milestones) return 0;
                    const milestone = company.milestones.find(m => m.name === milestoneName);
                    return milestone ? 1 : 0; // 1 if milestone exists, 0 if not
                });

                // Determine colors - green for completed, black for incomplete
                const backgroundColor = companies.map(company => {
                    if (!company.milestones) return '#f8f9fa'; // Light gray for no data
                    const milestone = company.milestones.find(m => m.name === milestoneName);
                    if (!milestone) return 'transparent'; // Transparent for milestone that doesn't exist
                    return milestone.completed ? '#28a745' : '#000000'; // Green for completed, black for incomplete
                });

                return {
                    label: milestoneName,
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: backgroundColor,
                    borderWidth: 0,
                    stack: 'milestones', // Stack all milestones together
                    // Custom property to track the full milestone name and completion status
                    milestoneData: companies.map(company => {
                        if (!company.milestones) return { name: milestoneName, completed: false, exists: false };
                        const milestone = company.milestones.find(m => m.name === milestoneName);
                        return {
                            name: milestoneName,
                            completed: milestone ? milestone.completed : false,
                            exists: !!milestone
                        };
                    })
                };
            });

            // Company labels (X-axis)
            const labels = companies.map(company => {
                const address = company.address || `Company ${company.id}`;
                return address.length > 15 ? address.substring(0, 15) + '...' : address;
            });

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                maxTicksLimit: false,
                                autoSkip: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: standardMilestones.length,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    // Show milestone names on Y-axis (shifted up by 1)
                                    if (value >= 1 && value <= standardMilestones.length) {
                                        const milestoneName = standardMilestones[Math.floor(value - 1)];
                                        return milestoneName.length > 20 ? milestoneName.substring(0, 20) + '...' : milestoneName;
                                    }
                                    return '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Milestones'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend since we have too many datasets
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const companyIndex = context[0].dataIndex;
                                    const company = companies[companyIndex];
                                    return company.address || `Company ${company.id}`;
                                },
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const companyIndex = context.dataIndex;
                                    const milestone = datasets[datasetIndex].milestoneData[companyIndex];
                                    
                                    if (!milestone.exists) {
                                        return `${milestone.name}: Not applicable`;
                                    }
                                    
                                    return `${milestone.name}: ${milestone.completed ? 'Completed ✓' : 'Incomplete ✗'}`;
                                }
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 0,
                            borderSkipped: false
                        }
                    }
                }
            });
        }

        function renderCompletionTrendsChart(ctx) {
            const completionsByDate = chartsData.completionsByDate;
            const timePeriod = document.getElementById('timePeriodSelector').value;
            
            let sortedDates = Object.keys(completionsByDate).sort();
            let labels, data;
            
            // Handle case where there's no completion data
            if (sortedDates.length === 0) {
                labels = ['No data'];
                data = [0];
            } else {
            
            switch (timePeriod) {
                case 'today':
                    // Show just today
                    const today = new Date().toISOString().slice(0, 10);
                    labels = [today];
                    data = [completionsByDate[today] || 0];
                    break;
                    
                case '7days':
                    // Show last 7 days
                    const last7Days = [];
                    const now = new Date();
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                        const dateStr = date.toISOString().slice(0, 10);
                        last7Days.push(dateStr);
                    }
                    labels = last7Days.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    data = last7Days.map(date => completionsByDate[date] || 0);
                    break;
                    
                case '30days':
                    // Show last 30 days (grouped by week for readability)
                    const last30Days = [];
                    const now30 = new Date();
                    const weeklyData = {};
                    
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(now30.getTime() - i * 24 * 60 * 60 * 1000);
                        const dateStr = date.toISOString().slice(0, 10);
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - date.getDay()); // Start of week
                        const weekKey = weekStart.toISOString().slice(0, 10);
                        
                        if (!weeklyData[weekKey]) {
                            weeklyData[weekKey] = 0;
                        }
                        weeklyData[weekKey] += completionsByDate[dateStr] || 0;
                    }
                    
                    labels = Object.keys(weeklyData).sort().map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    data = Object.keys(weeklyData).sort().map(date => weeklyData[date]);
                    break;
                    
                case 'all':
                default:
                    // Show all data, but limit to last 10 entries for readability
                    const lastEntries = sortedDates.slice(-10);
                    labels = lastEntries.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    data = lastEntries.map(date => completionsByDate[date]);
                    break;
            }
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Milestones Completed',
                        data: data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Period: ${context[0].label}`;
                                },
                                label: function(context) {
                                    const period = timePeriod === '30days' ? 'week' : 'day';
                                    return `${context.raw} milestones completed this ${period}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function renderBottleneckAnalysisChart(ctx) {
            const milestoneStats = chartsData.milestoneStats;
            
            // Debug: Log milestone stats to see what data we have
            console.log('Bottleneck Analysis - Milestone Stats:', milestoneStats);
            console.log('Chart Data:', chartsData);
            
            // Find milestones with lowest completion rates (bottlenecks)
            // Only include milestones that have some data (total > 0)
            const allMilestones = Object.entries(milestoneStats)
                .filter(([name, stats]) => stats.total > 0);
            
            console.log('All milestones with data:', allMilestones);
            
            // If we have no milestones with data, try to get all existing milestones from companies
            if (allMilestones.length === 0) {
                console.log('No milestone stats found, analyzing companies directly');
                
                // Build milestone stats directly from company data
                const directStats = {};
                const companies = chartsData.companies || [];
                
                companies.forEach(company => {
                    if (!company.milestones) return;
                    
                    company.milestones.forEach(milestone => {
                        if (!directStats[milestone.name]) {
                            directStats[milestone.name] = { completed: 0, total: 0, percentage: 0 };
                        }
                        directStats[milestone.name].total++;
                        if (milestone.completed) {
                            directStats[milestone.name].completed++;
                        }
                    });
                });
                
                // Calculate percentages
                Object.keys(directStats).forEach(name => {
                    const stats = directStats[name];
                    stats.percentage = stats.total > 0 ? (stats.completed / stats.total) * 100 : 0;
                });
                
                console.log('Direct milestone stats:', directStats);
                
                // Use direct stats if we found any
                const directMilestones = Object.entries(directStats)
                    .filter(([name, stats]) => stats.total > 0);
                
                if (directMilestones.length > 0) {
                    const bottlenecks = directMilestones
                        .sort((a, b) => a[1].percentage - b[1].percentage)
                        .slice(0, 8); // Show up to 8 bottlenecks
                    
                    const labels = bottlenecks.map(([name]) => 
                        name.length > 15 ? name.substring(0, 15) + '...' : name);
                    const data = bottlenecks.map(([name, stats]) => stats.percentage);
                    
                    // Generate a more varied color palette
                    const colors = bottlenecks.map((_, index) => {
                        const colorPalette = [
                            '#dc3545', '#fd7e14', '#ffc107', '#28a745',
                            '#6f42c1', '#e83e8c', '#6c757d', '#17a2b8'
                        ];
                        return colorPalette[index % colorPalette.length];
                    });

                    currentChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        padding: 8,
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const bottleneck = bottlenecks[context.dataIndex];
                                            const [name, stats] = bottleneck;
                                            return [
                                                `${name}:`,
                                                `${stats.completed}/${stats.total} completed`,
                                                `${Math.round(context.raw)}% completion rate`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                    return;
                }
            }
            
            // Sort by completion percentage (lowest first)
            const bottlenecks = allMilestones
                .sort((a, b) => a[1].percentage - b[1].percentage)
                .slice(0, 8); // Show up to 8 bottlenecks for better visibility

            console.log('Identified bottlenecks:', bottlenecks);

            // Handle case where there's no bottleneck data
            if (bottlenecks.length === 0) {
                const emptyLabels = ['No data available'];
                const emptyData = [100];
                const emptyColors = ['#6c757d'];
                
                currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: emptyLabels,
                        datasets: [{
                            data: emptyData,
                            backgroundColor: emptyColors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 8,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'No milestone data to analyze';
                                    }
                                }
                            }
                        }
                    }
                });
                return;
            }

            const labels = bottlenecks.map(([name]) => 
                name.length > 15 ? name.substring(0, 15) + '...' : name);
            const data = bottlenecks.map(([name, stats]) => stats.percentage);
            
            // Generate a more varied color palette
            const colors = bottlenecks.map((_, index) => {
                const colorPalette = [
                    '#dc3545', '#fd7e14', '#ffc107', '#28a745',
                    '#6f42c1', '#e83e8c', '#6c757d', '#17a2b8'
                ];
                return colorPalette[index % colorPalette.length];
            });

            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bottleneck = bottlenecks[context.dataIndex];
                                    const [name, stats] = bottleneck;
                                    return [
                                        `${name}:`,
                                        `${stats.completed}/${stats.total} completed`,
                                        `${Math.round(context.raw)}% completion rate`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Google Sheets Configuration
        async function checkSheetsStatus() {
            const isConfigured = await window.electronAPI.isSheetsConfigured();
            const alertElement = document.getElementById('sheetsAlert');
            const statusElement = document.getElementById('sheetsStatus');
            const cacheStatusElement = document.getElementById('cacheStatus');
            const refreshButton = document.getElementById('refreshData');
            
            if (isConfigured) {
                statusElement.textContent = 'Connected to Google Sheets ✓';
                alertElement.className = 'alert alert-success alert-dismissible fade show';
                document.getElementById('configureSheets').textContent = 'Reconfigure';
                document.getElementById('useLocalStorage').style.display = 'none';
                refreshButton.style.display = 'inline-block';
                cacheStatusElement.textContent = '';
            } else {
                statusElement.textContent = 'Using local storage. Configure Google Sheets for multi-user access.';
                alertElement.className = 'alert alert-warning alert-dismissible fade show';
                document.getElementById('configureSheets').textContent = 'Configure Google Sheets';
                document.getElementById('useLocalStorage').style.display = 'inline-block';
                refreshButton.style.display = 'none';
                cacheStatusElement.textContent = '';
            }
            
            alertElement.style.display = 'block';
        }

        // Event listeners for Google Sheets configuration
        document.getElementById('configureSheets').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('sheetsConfigModal'));
            modal.show();
        });

        document.getElementById('useLocalStorage').addEventListener('click', function() {
            document.getElementById('sheetsAlert').style.display = 'none';
        });

        // Force refresh data event listener
        document.getElementById('refreshData').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Refreshing...';
            
            try {
                const result = await window.electronAPI.forceRefreshData();
                if (result.success) {
                    // Refresh the UI
                    renderCompanies('');
                    updateChartsIfVisible();
                    checkSheetsStatus();
                    
                    // Show success feedback
                    button.innerHTML = '<i class="bi bi-check"></i> Refreshed';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Failed to refresh data');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Error refreshing data: ' + error.message);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        document.getElementById('showSetupGuide').addEventListener('click', function() {
            const guide = document.getElementById('setupGuide');
            if (guide.classList.contains('show')) {
                guide.classList.remove('show');
                this.innerHTML = '<i class="bi bi-question-circle"></i> Show Detailed Setup Guide';
            } else {
                guide.classList.add('show');
                this.innerHTML = '<i class="bi bi-question-circle"></i> Hide Setup Guide';
            }
        });

        document.getElementById('resetConfig').addEventListener('click', async function() {
            if (confirm('Are you sure you want to reset the Google Sheets configuration?')) {
                const result = await window.electronAPI.resetSheetsConfig();
                if (result.success) {
                    alert('Configuration reset successfully!');
                    checkSheetsStatus();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sheetsConfigModal'));
                    modal.hide();
                } else {
                    alert('Error: ' + result.message);
                }
            }
        });

        document.getElementById('saveSheetConfig').addEventListener('click', async function() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const credentialsContent = document.getElementById('credentialsFile').value.trim();
            
            if (!spreadsheetId || !credentialsContent) {
                alert('Please fill in both the Spreadsheet ID and Credentials');
                return;
            }

            try {
                JSON.parse(credentialsContent); // Validate JSON
            } catch (e) {
                alert('Invalid JSON credentials. Please check the format.');
                return;
            }

            this.disabled = true;
            this.textContent = 'Connecting...';

            const result = await window.electronAPI.configureSheets(credentialsContent, spreadsheetId);
            
            if (result.success) {
                alert('Google Sheets configured successfully!');
                checkSheetsStatus();
                const modal = bootstrap.Modal.getInstance(document.getElementById('sheetsConfigModal'));
                modal.hide();
                // Clear the form
                document.getElementById('spreadsheetId').value = '';
                document.getElementById('credentialsFile').value = '';
                // Refresh the companies list to load from Google Sheets
                renderCompanies('');
            } else {
                alert('Configuration failed: ' + result.message);
            }

            this.disabled = false;
            this.textContent = 'Connect to Google Sheets';
        });

        // Helper function to update charts after data changes
        async function updateChartsIfVisible() {
            // Always update charts since analytics is always visible
            // Add a small delay to ensure DOM updates are complete
            setTimeout(() => {
                try {
                    console.log('updateChartsIfVisible: Starting chart update');
                    console.log('Global companies data length:', globalCompaniesData.length);
                    
                    // Force refresh of chart data by reprocessing
                    chartsData = processChartData(globalCompaniesData);
                    console.log('Chart data processed:', chartsData);
                    renderCurrentChart();
                    console.log('Chart rendered successfully');
                } catch (error) {
                    console.error('Error in updateChartsIfVisible:', error);
                }
            }, 50);
        }
       
        // Internal Email Templates functionality
        
        // Load internal email templates from localStorage
        function loadInternalEmailTemplates() {
            const saved = localStorage.getItem('internalEmailTemplates');
            let templates = saved ? JSON.parse(saved) : getDefaultInternalTemplates();
            
            internalEmailTemplates = templates;
            return internalEmailTemplates;
        }

        // Save internal email templates to localStorage
        function saveInternalEmailTemplates() {
            localStorage.setItem('internalEmailTemplates', JSON.stringify(internalEmailTemplates));
        }

        // Get default internal email templates
        function getDefaultInternalTemplates() {
            return [
                {
                    id: 1,
                    name: "Keys Ready - Internal",
                    milestone: "Keys",
                    type: "internal",
                    internalEmail: "manager@company.com",
                    subject: "Internal: Keys Ready - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Keys\nStatus: Completed\nDate: {currentDate}\n\nKeys are now ready for pickup. Please follow up with client.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 2,
                    name: "Power Connected - Internal",
                    milestone: "Power",
                    type: "internal",
                    internalEmail: "team@company.com",
                    subject: "Internal: Power Connected - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Power\nStatus: Completed\nDate: {currentDate}\n\nPower has been successfully connected. Next steps can proceed.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 3,
                    name: "Water Connected - Internal",
                    milestone: "Water",
                    type: "internal",
                    internalEmail: "team@company.com",
                    subject: "Internal: Water Connected - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Water\nStatus: Completed\nDate: {currentDate}\n\nWater service has been connected. Utilities setup is progressing.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 4,
                    name: "Deposit Held - Internal",
                    milestone: "Deposit held",
                    type: "internal",
                    internalEmail: "finance@company.com",
                    subject: "Internal: Deposit Held - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Deposit held\nStatus: Completed\nDate: {currentDate}\n\nClient deposit has been received and secured. Financial milestone achieved.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 5,
                    name: "Balance Received - Internal",
                    milestone: "Balance",
                    type: "internal",
                    internalEmail: "finance@company.com",
                    subject: "Internal: Balance Received - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Balance\nStatus: Completed\nDate: {currentDate}\n\nFull payment balance has been received. Financial obligations complete.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 6,
                    name: "Move-out Complete - Internal",
                    milestone: "Move-out",
                    type: "internal",
                    internalEmail: "team@company.com",
                    subject: "Internal: Move-out Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Move-out\nStatus: Completed\nDate: {currentDate}\n\nTenant move-out has been completed. Property is ready for next phase.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 7,
                    name: "Quote Provided - Internal",
                    milestone: "Quote",
                    type: "internal",
                    internalEmail: "sales@company.com",
                    subject: "Internal: Quote Provided - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Quote\nStatus: Completed\nDate: {currentDate}\n\nProject quote has been provided to client. Awaiting response.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 8,
                    name: "Owner Contacted - Internal",
                    milestone: "Contact owner",
                    type: "internal",
                    internalEmail: "team@company.com",
                    subject: "Internal: Owner Contacted - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Contact owner\nStatus: Completed\nDate: {currentDate}\n\nProperty owner has been successfully contacted. Communication established.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 9,
                    name: "Inspection Video + Quote Sent - Internal",
                    milestone: "Email inspection video + quote",
                    type: "internal",
                    internalEmail: "team@company.com",
                    subject: "Internal: Inspection Video + Quote Sent - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Email inspection video + quote\nStatus: Completed\nDate: {currentDate}\n\nInspection video and quote have been emailed to client. Follow-up scheduled.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 10,
                    name: "Follow Up Date Set - Internal",
                    milestone: "Follow up date",
                    type: "internal",
                    internalEmail: "team@company.com",
                    subject: "Internal: Follow Up Date Set - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Follow up date\nStatus: Completed\nDate: {currentDate}\n\nFollow-up date has been scheduled with client. Calendar updated.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 11,
                    name: "Approval Received - Internal",
                    milestone: "Approval",
                    type: "internal",
                    internalEmail: "manager@company.com",
                    subject: "Internal: Approval Received - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Approval\nStatus: Completed\nDate: {currentDate}\n\nProject approval has been received from client. Proceeding to next phase.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 12,
                    name: "Funds Secured - Internal",
                    milestone: "Funds",
                    type: "internal",
                    internalEmail: "finance@company.com",
                    subject: "Internal: Funds Secured - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Funds\nStatus: Completed\nDate: {currentDate}\n\nProject funds have been secured and verified. Financial clearance granted.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 13,
                    name: "Materials Ordered - Internal",
                    milestone: "Order of materials",
                    type: "internal",
                    internalEmail: "procurement@company.com",
                    subject: "Internal: Materials Ordered - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Order of materials\nStatus: Completed\nDate: {currentDate}\n\nAll required materials have been ordered. Delivery timeline confirmed.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 14,
                    name: "Prebill Issued - Internal",
                    milestone: "Prebill",
                    type: "internal",
                    internalEmail: "finance@company.com",
                    subject: "Internal: Prebill Issued - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Prebill\nStatus: Completed\nDate: {currentDate}\n\nPrebill has been issued to client. Payment processing initiated.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 15,
                    name: "Wait List Updated - Internal",
                    milestone: "Wait list",
                    type: "internal",
                    internalEmail: "scheduler@company.com",
                    subject: "Internal: Wait List Updated - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Wait list\nStatus: Completed\nDate: {currentDate}\n\nProject has been added to wait list. Scheduling department notified.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 16,
                    name: "Rehab Started - Internal",
                    milestone: "Rehab start",
                    type: "internal",
                    internalEmail: "construction@company.com",
                    subject: "Internal: Rehab Started - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Rehab start\nStatus: Completed\nDate: {currentDate}\n\nRehabilitation work has officially begun. Construction team deployed.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 17,
                    name: "Add Ons Processed - Internal",
                    milestone: "Add ons",
                    type: "internal",
                    internalEmail: "sales@company.com",
                    subject: "Internal: Add Ons Processed - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Add ons\nStatus: Completed\nDate: {currentDate}\n\nAdditional services have been processed and added to project scope.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 18,
                    name: "Rehab Completed - Internal",
                    milestone: "Rehab ends",
                    type: "internal",
                    internalEmail: "construction@company.com",
                    subject: "Internal: Rehab Completed - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Rehab ends\nStatus: Completed\nDate: {currentDate}\n\nRehabilitation work has been completed. Final inspections pending.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 19,
                    name: "Site Cleanup Complete - Internal",
                    milestone: "Dump and pick up material left on site",
                    type: "internal",
                    internalEmail: "cleanup@company.com",
                    subject: "Internal: Site Cleanup Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Dump and pick up material left on site\nStatus: Completed\nDate: {currentDate}\n\nAll materials have been removed from site. Cleanup completed.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 20,
                    name: "Vendor Status Confirmed - Internal",
                    milestone: "Vendor?",
                    type: "internal",
                    internalEmail: "procurement@company.com",
                    subject: "Internal: Vendor Status Confirmed - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Vendor?\nStatus: Completed\nDate: {currentDate}\n\nVendor requirements have been confirmed and documented.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 21,
                    name: "Cleaning Complete - Internal",
                    milestone: "Cleaning",
                    type: "internal",
                    internalEmail: "cleaning@company.com",
                    subject: "Internal: Cleaning Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Cleaning\nStatus: Completed\nDate: {currentDate}\n\nProfessional cleaning has been completed. Property is move-in ready.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 22,
                    name: "Quality Control Complete - Internal",
                    milestone: "Quality control -final walkthrough",
                    type: "internal",
                    internalEmail: "quality@company.com",
                    subject: "Internal: Quality Control Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Quality control -final walkthrough\nStatus: Completed\nDate: {currentDate}\n\nFinal quality control walkthrough completed. All standards met.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 23,
                    name: "Final Inspection Complete - Internal",
                    milestone: "Final inspection",
                    type: "internal",
                    internalEmail: "inspector@company.com",
                    subject: "Internal: Final Inspection Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Final inspection\nStatus: Completed\nDate: {currentDate}\n\nFinal inspection has been completed and approved. Project cleared.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 24,
                    name: "Lawn Care Scheduled - Internal",
                    milestone: "Open recurring task lawn care",
                    type: "internal",
                    internalEmail: "maintenance@company.com",
                    subject: "Internal: Lawn Care Scheduled - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Open recurring task lawn care\nStatus: Completed\nDate: {currentDate}\n\nRecurring lawn care services have been scheduled and activated.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 25,
                    name: "Move-in Inspection Complete - Internal",
                    milestone: "Move in inspection",
                    type: "internal",
                    internalEmail: "inspector@company.com",
                    subject: "Internal: Move-in Inspection Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Move in inspection\nStatus: Completed\nDate: {currentDate}\n\nMove-in inspection completed with new tenant. Documentation filed.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 26,
                    name: "Rehab Tasks Billed - Internal",
                    milestone: "Assign all rehab tasks to bill",
                    type: "internal",
                    internalEmail: "billing@company.com",
                    subject: "Internal: Rehab Tasks Billed - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Assign all rehab tasks to bill\nStatus: Completed\nDate: {currentDate}\n\nAll rehabilitation tasks have been assigned to billing. Invoice processing initiated.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 27,
                    name: "Video Uploaded - Internal",
                    milestone: "Video upload",
                    type: "internal",
                    internalEmail: "media@company.com",
                    subject: "Internal: Video Uploaded - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Video upload\nStatus: Completed\nDate: {currentDate}\n\nProject video has been uploaded and is available for client review.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 28,
                    name: "Utilities Turned Off - Internal",
                    milestone: "Turn off utilities",
                    type: "internal",
                    internalEmail: "utilities@company.com",
                    subject: "Internal: Utilities Turned Off - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Turn off utilities\nStatus: Completed\nDate: {currentDate}\n\nAll utilities have been disconnected as requested. Service termination confirmed.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 29,
                    name: "Property Listed - Internal",
                    milestone: "List property",
                    type: "internal",
                    internalEmail: "marketing@company.com",
                    subject: "Internal: Property Listed - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: List property\nStatus: Completed\nDate: {currentDate}\n\nProperty has been listed on all relevant platforms. Marketing campaign active.\n\nSystem Generated - 10 Stars Property Management"
                },
                {
                    id: 30,
                    name: "Billing Finalized - Internal",
                    milestone: "Billing finalized",
                    type: "internal",
                    internalEmail: "finance@company.com",
                    subject: "Internal: Billing Finalized - {address}",
                    body: "Team Update:\n\nProperty: {address}\nContact: {contactName} ({contactEmail})\nMilestone: Billing finalized\nStatus: Completed\nDate: {currentDate}\n\nAll billing has been finalized. Project financially complete.\n\nSystem Generated - 10 Stars Property Management"
                }
            ];
        }

        // Populate milestone dropdown for internal templates
        function populateInternalMilestoneDropdown() {
            const dropdown = document.getElementById('internalTemplateMilestone');
            dropdown.innerHTML = '<option value="">Select Milestone (Optional)</option>';
            
            const milestones = [
                'Keys', 'Power', 'Water', 'Deposit held', 'Balance', 'Move-out', 
                'Quote', 'Contact owner', 'Email inspection video + quote', 'Follow up date',
                'Access', 'Inspection', 'Contractor coordination', 'Material delivery',
                'Work start', 'Progress update', 'Quality check', 'Work completion',
                'Final inspection', 'Client walkthrough', 'Documentation', 'Billing'
            ];

            milestones.forEach(milestone => {
                const option = document.createElement('option');
                option.value = milestone;
                option.textContent = milestone;
                dropdown.appendChild(option);
            });
        }

        // Render internal templates list
        function renderInternalTemplatesList(searchTerm = '') {
            const templatesList = document.getElementById('internalTemplatesList');
            const searchValue = searchTerm.toLowerCase();
            
            const filteredTemplates = internalEmailTemplates.filter(template => 
                template.name.toLowerCase().includes(searchValue) ||
                (template.milestone && template.milestone.toLowerCase().includes(searchValue))
            );

            templatesList.innerHTML = '';

            filteredTemplates.forEach(template => {
                const templateItem = document.createElement('div');
                templateItem.className = 'list-group-item list-group-item-action';
                templateItem.style.cursor = 'pointer';
                templateItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${template.name}</h6>
                        <small class="text-warning">Internal</small>
                    </div>
                    <p class="mb-1 text-muted small">${template.milestone || 'No milestone'}</p>
                    <small class="text-muted">${template.internalEmail || 'No default email'}</small>
                `;
                
                templateItem.addEventListener('click', function() {
                    editInternalTemplate(template);
                });
                
                templatesList.appendChild(templateItem);
            });

            if (filteredTemplates.length === 0) {
                templatesList.innerHTML = '<div class="text-center text-muted py-3">No internal templates found</div>';
            }
        }

        // Edit internal template
        function editInternalTemplate(template) {
            currentEditingInternalTemplate = template;
            
            // Fill form with template data
            document.getElementById('internalTemplateName').value = template.name;
            document.getElementById('internalTemplateMilestone').value = template.milestone || '';
            document.getElementById('internalTemplateEmail').value = template.internalEmail || '';
            document.getElementById('internalTemplateSubject').value = template.subject;
            document.getElementById('internalTemplateBody').value = template.body;
            
            // Show editor and hide welcome message
            document.getElementById('internalTemplateEditor').style.display = 'block';
            document.getElementById('internalWelcomeMessage').style.display = 'none';
            document.getElementById('deleteInternalTemplate').style.display = 'none'; // Always hide delete button
        }

        // Create new internal template
        function createNewInternalTemplate() {
            currentEditingInternalTemplate = null;
            
            // Clear form
            document.getElementById('internalTemplateForm').reset();
            
            // Show editor and hide welcome message
            document.getElementById('internalTemplateEditor').style.display = 'block';
            document.getElementById('internalWelcomeMessage').style.display = 'none';
            document.getElementById('deleteInternalTemplate').style.display = 'none';
        }

        // Internal template form event listeners
        document.getElementById('internalTemplateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const templateData = {
                name: formData.get('internalTemplateName'),
                milestone: formData.get('internalTemplateMilestone'),
                type: 'internal',
                internalEmail: formData.get('internalTemplateEmail'),
                subject: formData.get('internalTemplateSubject'),
                body: formData.get('internalTemplateBody')
            };

            if (currentEditingInternalTemplate) {
                // Update existing template only
                const index = internalEmailTemplates.findIndex(t => t.id === currentEditingInternalTemplate.id);
                if (index !== -1) {
                    internalEmailTemplates[index] = { ...currentEditingInternalTemplate, ...templateData };
                }
                
                saveInternalEmailTemplates();
                renderInternalTemplatesList();
                closeInternalTemplateEditor();
            } else {
                // No longer allow creating new templates
                alert('Creating new templates is not allowed. You can only edit existing templates.');
            }
            closeInternalTemplateEditor();
        });

        // Close internal template editor
        function closeInternalTemplateEditor() {
            document.getElementById('internalTemplateEditor').style.display = 'none';
            document.getElementById('internalWelcomeMessage').style.display = 'block';
            currentEditingInternalTemplate = null;
        }

        // Delete internal template
        document.getElementById('deleteInternalTemplate').addEventListener('click', function() {
            if (currentEditingInternalTemplate && confirm('Are you sure you want to delete this internal template?')) {
                internalEmailTemplates = internalEmailTemplates.filter(t => t.id !== currentEditingInternalTemplate.id);
                saveInternalEmailTemplates();
                renderInternalTemplatesList();
                closeInternalTemplateEditor();
            }
        });

        // Internal template editor controls
        document.getElementById('closeInternalTemplateEditor').addEventListener('click', closeInternalTemplateEditor);
        document.getElementById('cancelInternalEdit').addEventListener('click', closeInternalTemplateEditor);
        // Removed event listeners for creating new templates

        // Reset internal templates to defaults
        document.getElementById('resetInternalToDefaults').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all internal templates to defaults? This will remove any custom changes you made.')) {
                localStorage.removeItem('internalEmailTemplates');
                loadInternalEmailTemplates();
                renderInternalTemplatesList();
                closeInternalTemplateEditor();
            }
        });

        // Internal template search
        document.getElementById('internalTemplateSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            renderInternalTemplatesList(searchTerm);
        });

        // Preview internal template
        document.getElementById('previewInternalTemplate').addEventListener('click', function() {
            const name = document.getElementById('internalTemplateName').value;
            const subject = document.getElementById('internalTemplateSubject').value;
            const body = document.getElementById('internalTemplateBody').value;
            const internalEmail = document.getElementById('internalTemplateEmail').value;
            
            if (!name || !subject || !body) {
                alert('Please fill in all required fields before previewing.');
                return;
            }

            // Sample company data for preview
            const sampleCompany = {
                id: 1,
                contactName: 'John Doe',
                contactEmail: 'john@example.com',
                address: '123 Main St, City, State',
                createdDate: '2024-01-15'
            };
            const sampleMilestone = 'Keys';
            const sampleMilestoneObj = { completedDate: '2024-02-01' };

            try {
                const previewSubject = replaceTemplateVariables(subject, sampleCompany, sampleMilestone, sampleMilestoneObj);
                const previewBody = replaceTemplateVariables(body, sampleCompany, sampleMilestone, sampleMilestoneObj);
                
                const previewWindow = window.open('', '_blank', 'width=600,height=500');
                previewWindow.document.write(`
                    <html>
                    <head>
                        <title>Internal Template Preview - ${name}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                background: #f5f5f5;
                            }
                            .email-preview {
                                background: white;
                                padding: 20px;
                                border-radius: 8px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                max-width: 600px;
                                margin: 0 auto;
                            }
                            .header { 
                                background: #ff9800; 
                                color: white; 
                                padding: 15px; 
                                margin: -20px -20px 20px -20px;
                                border-radius: 8px 8px 0 0;
                            }
                            .field { margin-bottom: 15px; }
                            .field label { font-weight: bold; color: #ff9800; }
                            .field div { margin-top: 5px; }
                            pre { white-space: pre-wrap; font-family: inherit; }
                        </style>
                    </head>
                    <body>
                        <div class="email-preview">
                            <div class="header">
                                <h2>📨 Internal Template Preview</h2>
                                <p style="margin: 0; opacity: 0.9;">Template: ${name}</p>
                            </div>
                            <div class="field">
                                <label>To:</label>
                                <div>${internalEmail || '[Will prompt for email address]'}</div>
                            </div>
                            <div class="field">
                                <label>Subject:</label>
                                <div>${previewSubject}</div>
                            </div>
                            <div class="field">
                                <label>Body:</label>
                                <div><pre>${previewBody}</pre></div>
                            </div>
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 12px;">
                                This is a preview using sample data. Actual emails will use real project information.
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                previewWindow.document.close();
            } catch (error) {
                console.error('Error generating template preview:', error);
                alert('Error generating preview. Please check your template syntax.');
            }
        });

        // Toggle milestone completion status
        async function toggleMilestone(e) {
            const checkbox = e.target;
            const companyId = parseInt(checkbox.dataset.companyId);
            const milestoneId = parseInt(checkbox.dataset.milestoneId);

            // Find the loading spinner for this specific checkbox
            const milestoneContainer = checkbox.closest('li.list-group-item');
            const loadingSpinner = milestoneContainer.querySelector('.milestone-loading-spinner');
            const dateInput = milestoneContainer.querySelector('.milestone-date-input');
            const milestoneLabel = milestoneContainer.querySelector('span.fw-semibold');

            // Show loading spinner and hide checkbox
            checkbox.style.display = 'none';
            if (loadingSpinner) {
                loadingSpinner.style.display = 'block';
            }

            try {
                // Use the global state and update it
                const company = globalCompaniesData.find(c => c.id == companyId || c.id === String(companyId) || c.id === Number(companyId));
                if (!company) {
                    console.error('Company not found:', companyId);
                    throw new Error('Company not found');
                }
                if (!company.milestones) {
                    console.error('Company has no milestones:', companyId);
                    throw new Error('Company has no milestones');
                }
                const milestone = company.milestones.find(m => m.id == milestoneId || m.id === String(milestoneId) || m.id === Number(milestoneId));
                if (!milestone) {
                    console.error('Milestone not found:', milestoneId);
                    throw new Error('Milestone not found');
                }

                // Update milestone state
                milestone.completed = checkbox.checked;
                milestone.completedDate = milestone.completed ? new Date().toISOString().slice(0, 10) : null;

                // Update UI elements based on completion status
                if (checkbox.checked) {
                    if (dateInput) {
                        dateInput.style.visibility = 'visible';
                        dateInput.value = milestone.completedDate;
                    }
                    if (milestoneLabel) {
                        milestoneLabel.classList.remove('text-dark');
                        milestoneLabel.classList.add('text-success');
                    }
                } else {
                    if (dateInput) {
                        dateInput.style.visibility = 'hidden';
                    }
                    if (milestoneLabel) {
                        milestoneLabel.classList.remove('text-success');
                        milestoneLabel.classList.add('text-dark');
                    }
                }

                // Save to spreadsheet and wait for confirmation
                await window.electronAPI.saveCompanies(globalCompaniesData);
                
                // Update charts with the new data
                updateChartsIfVisible();

            } catch (error) {
                console.error('Error toggling milestone:', error);
                
                // Revert checkbox state on error
                checkbox.checked = !checkbox.checked;
                
                // Revert UI changes
                if (checkbox.checked) {
                    if (dateInput) {
                        dateInput.style.visibility = 'visible';
                    }
                    if (milestoneLabel) {
                        milestoneLabel.classList.remove('text-dark');
                        milestoneLabel.classList.add('text-success');
                    }
                } else {
                    if (dateInput) {
                        dateInput.style.visibility = 'hidden';
                    }
                    if (milestoneLabel) {
                        milestoneLabel.classList.remove('text-success');
                        milestoneLabel.classList.add('text-dark');
                    }
                }
                
                alert('Failed to update milestone. Please try again.');
            } finally {
                // Hide loading spinner and show checkbox
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                checkbox.style.display = 'block';
            }
        }

        // View notes for a milestone
        async function viewNotes(e) {
            const button = e.target;
            const companyId = parseInt(button.dataset.companyId);
            const milestoneId = parseInt(button.dataset.milestoneId);
            const milestoneName = button.dataset.milestoneName;

            const companies = await window.electronAPI.getCompanies();
            const company = companies.find(c => c.id == companyId || c.id === String(companyId) || c.id === Number(companyId));
            if (!company) {
                console.error('Company not found:', companyId);
                return;
            }
            if (!company.milestones) {
                console.error('Company has no milestones:', companyId);
                return;
            }
            const milestone = company.milestones.find(m => m.id == milestoneId || m.id === String(milestoneId) || m.id === Number(milestoneId));
            if (!milestone) {
                console.error('Milestone not found:', milestoneId);
                return;
            }

            document.getElementById('milestoneName').textContent = milestoneName;

            const existingNotes = document.getElementById('existingNotes');
            existingNotes.innerHTML = '';

            if (milestone.notes && milestone.notes.length > 0) {
                milestone.notes.forEach((note, idx) => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'mb-3 p-3 bg-light rounded d-flex justify-content-between align-items-center';
                    noteDiv.innerHTML = `
                        <div>
                            <p class="mb-1">${note.text}</p>
                            <small class="text-muted">${new Date(note.timestamp).toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger delete-note-btn" data-note-idx="${idx}">Delete</button>
                    `;
                    existingNotes.appendChild(noteDiv);

                    // Add delete event
                    noteDiv.querySelector('.delete-note-btn').addEventListener('click', async function() {
                        milestone.notes.splice(idx, 1);
                        await window.electronAPI.saveCompanies(companies);

                        // Remove the noteDiv from the DOM
                        noteDiv.remove();

                        // Optionally, update the note count on the button if needed
                        button.innerHTML = `${milestone.notes.length} note(s)`;
                    });
                });
            } else {
                existingNotes.innerHTML = '<p>No notes yet.</p>';
            }

            const saveButton = document.getElementById('saveNote');
            saveButton.onclick = async function() {
                const newNoteText = document.getElementById('newNote').value.trim();
                if (newNoteText) {
                    if (!milestone.notes) {
                        milestone.notes = [];
                    }
                    milestone.notes.push({
                        text: newNoteText,
                        timestamp: new Date().toISOString()
                    });
                    await window.electronAPI.saveCompanies(companies);
                    document.getElementById('newNote').value = '';

                    // Update notes list directly
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'mb-3 p-3 bg-light rounded';
                    noteDiv.innerHTML = `
                        <p>${newNoteText}</p>
                        <small class="text-muted">${new Date().toLocaleString()}</small>
                    `;
                    existingNotes.appendChild(noteDiv);

                    // Update note count on milestone button
                    button.innerHTML = `${milestone.notes.length} note(s)`;

                    // Close modal after saving
                    const modal = bootstrap.Modal.getInstance(document.getElementById('notesModal'));
                    modal.hide();
                }
            };

            const modal = new bootstrap.Modal(document.getElementById('notesModal'));
            modal.show();
        }

        // Search companies (trigger on Enter key)
        document.getElementById('searchCompany').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const term = e.target.value;
                renderCompanies(term);
            }
        });

        // Add event listeners for new filter options
        document.getElementById('searchFilter').addEventListener('change', function() {
            const term = document.getElementById('searchCompany').value;
            renderCompanies(term);
        });

        document.getElementById('sortBy').addEventListener('change', function() {
            const term = document.getElementById('searchCompany').value;
            renderCompanies(term);
        });

        document.getElementById('dateFrom').addEventListener('change', function() {
            const term = document.getElementById('searchCompany').value;
            renderCompanies(term);
        });

        document.getElementById('dateTo').addEventListener('change', function() {
            const term = document.getElementById('searchCompany').value;
            renderCompanies(term);
        });

        document.getElementById('clearFilters').addEventListener('click', function() {
            document.getElementById('searchCompany').value = '';
            document.getElementById('searchFilter').value = 'all';
            document.getElementById('sortBy').value = 'newest';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            renderCompanies('');
        });

        // Add New Project button event listener
        document.getElementById('addNewProjectBtn').addEventListener('click', function() {
            // Set today's date as default
            document.getElementById('modalCreatedDate').value = new Date().toISOString().split('T')[0];
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
            modal.show();
        });

        // Save New Project from modal
        document.getElementById('saveNewProject').addEventListener('click', async function() {
            const contactName = document.getElementById('modalContactName').value.trim();
            const createdDate = document.getElementById('modalCreatedDate').value;
            const address = document.getElementById('modalAddress').value.trim();
            const contactEmail = document.getElementById('modalContactEmail').value.trim();

            // Validate required fields
            if (!contactName || !createdDate || !address || !contactEmail) {
                alert('Please fill in all required fields.');
                return;
            }

            // Close the modal immediately
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
            modal.hide();
            
            // Clear the form
            document.getElementById('addProjectModalForm').reset();

            // Create a temporary loading project ID
            const tempId = 'loading_' + Date.now();
            
            // Add loading placeholder to the projects list
            const list = document.getElementById('companiesList');
            const loadingHtml = `
                <div class="card mb-3" id="project-${tempId}">
                    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mb-0">Creating project: ${address}</h5>
                        </div>
                        <small class="text-muted">Saving...</small>
                    </div>
                </div>
            `;
            
            // Add to top of list
            list.insertAdjacentHTML('afterbegin', loadingHtml);

            try {
                // Use global companies data instead of loading fresh
                const companies = [...globalCompaniesData]; // Create a copy

                const defaultMilestones = [
                    { id: 1, name: 'Keys', completed: false },
                    { id: 2, name: 'Power', completed: false },
                    { id: 3, name: 'Water', completed: false },
                    { id: 4, name: 'Deposit held', completed: false },
                    { id: 5, name: 'Balance', completed: false },
                    { id: 6, name: 'Move-out', completed: false },
                    { id: 7, name: 'Quote', completed: false },
                    { id: 8, name: 'Contact owner', completed: false },
                    { id: 9, name: 'Email inspection video + quote', completed: false },
                    { id: 10, name: 'Follow up date', completed: false },
                    { id: 11, name: 'Approval', completed: false },
                    { id: 12, name: 'Funds', completed: false },
                    { id: 13, name: 'Order of materials', completed: false },
                    { id: 14, name: 'Prebill', completed: false },
                    { id: 15, name: 'Wait list', completed: false },
                    { id: 16, name: 'Rehab start', completed: false },
                    { id: 17, name: 'Add ons', completed: false },
                    { id: 18, name: 'Rehab ends', completed: false },
                    { id: 19, name: 'Dump and pick up material left on site', completed: false },
                { id: 20, name: 'Vendor?', completed: false },
                { id: 21, name: 'Cleaning', completed: false },
                { id: 22, name: 'Quality control -final walkthrough', completed: false },
                { id: 23, name: 'Final inspection', completed: false },
                { id: 24, name: 'Open recurring task lawn care', completed: false },
                { id: 25, name: 'Move in inspection', completed: false },
                { id: 26, name: 'Assign all rehab tasks to bill', completed: false },
                { id: 27, name: 'Video upload', completed: false },
                { id: 28, name: 'Turn off utilities', completed: false },
                { id: 29, name: 'List property', completed: false },
                { id: 30, name: 'Billing finalized', completed: false }
            ];

            const newCompany = {
                id: companies.length > 0 ? Math.max(...companies.map(c => c.id || 0)) + 1 : 1,
                createdDate: createdDate,
                address: address,
                contactName: contactName,
                contactEmail: contactEmail,
                milestones: defaultMilestones.map(m => ({ ...m }))
            };

            companies.push(newCompany);
            
            await window.electronAPI.saveCompanies(companies);
            
            // Update global state
            globalCompaniesData = companies;
            
            // Remove loading placeholder
            const loadingElement = document.getElementById(`project-${tempId}`);
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // Refresh the companies list to show the new project
            await renderCompanies('');
            
            // Update charts when new company is added
            updateChartsIfVisible();
            
        } catch (error) {
            console.error('Failed to save new company from modal:', error.message);
            
            // Remove loading placeholder on error
            const loadingElement = document.getElementById(`project-${tempId}`);
            if (loadingElement) {
                loadingElement.remove();
            }
            
            alert('Error saving project: ' + error.message);
        }
        });

        // Reset modal form when hidden
        document.getElementById('addProjectModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('addProjectModalForm').reset();
        });

        // Fix modal closing issue by resetting note textarea and notes list when modal is hidden
        document.getElementById('notesModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('existingNotes').innerHTML = '';
            document.getElementById('newNote').value = '';
        });

        // Add color selection functionality for tags
        document.querySelectorAll('.color-option').forEach(colorBtn => {
            colorBtn.addEventListener('click', function() {
                // Remove selected class from all color options
                document.querySelectorAll('.color-option').forEach(btn => {
                    btn.style.border = '2px solid transparent';
                });
                // Add selected class to clicked option
                this.style.border = '2px solid #000';
                document.getElementById('selectedColor').value = this.dataset.color;
            });
        });

        // Reset tag modal when it's shown
        document.getElementById('tagModal').addEventListener('shown.bs.modal', function() {
            // Reset color selection
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
            });
            // Set default color selection
            const defaultColorBtn = document.querySelector('.color-option[data-color="secondary"]');
            if (defaultColorBtn) {
                defaultColorBtn.style.border = '2px solid #000';
            }
            document.getElementById('selectedColor').value = 'secondary';
            
            // Hide delete button for new tags (will be shown in click handler for existing tags)
            const tagIdx = this.dataset.tagIdx;
            if (tagIdx === '' || tagIdx === undefined) {
                document.getElementById('deleteTag').style.display = 'none';
                document.getElementById('tagInput').value = ''; // Clear input for new tags
            }
        });

        // Add event listener for the Save Tag button
        document.getElementById('saveTag').addEventListener('click', async function() {
            const tagModal = document.getElementById('tagModal');
            const companyId = parseInt(tagModal.dataset.companyId);
            const milestoneId = parseInt(tagModal.dataset.milestoneId);
            const tagIdx = tagModal.dataset.tagIdx;
            const tagInput = document.getElementById('tagInput').value.trim();
            const selectedColor = document.getElementById('selectedColor').value;
            
            if (tagInput) {
                // Find the loading spinner for this milestone
                const milestoneItems = document.querySelectorAll(`[data-company-id="${companyId}"][data-milestone-id="${milestoneId}"]`);
                let loadingSpinner = null;
                
                // Find the milestone item container
                milestoneItems.forEach(item => {
                    const milestoneContainer = item.closest('li.list-group-item');
                    if (milestoneContainer) {
                        loadingSpinner = milestoneContainer.querySelector('.tag-loading-spinner');
                    }
                });
                
                // Show loading spinner
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'block';
                }
                
                try {
                    const companiesData = await window.electronAPI.getCompanies();
                    const companyData = companiesData.find(c => c.id === companyId);
                    if (!companyData) {
                        console.error('Company not found:', companyId);
                        return;
                    }
                    if (!companyData.milestones) {
                        console.error('Company has no milestones:', companyId);
                        return;
                    }
                    const milestoneData = companyData.milestones.find(m => m.id === milestoneId);
                    if (!milestoneData) {
                        console.error('Milestone not found:', milestoneId);
                        return;
                    }
                    
                    if (!Array.isArray(milestoneData.tags)) {
                        milestoneData.tags = [];
                    }
                    
                    const tagObject = {
                        text: tagInput,
                        color: selectedColor
                    };
                    
                    if (tagIdx === '') {
                        // Adding new tag
                        if (milestoneData.tags.length < 3) {
                            milestoneData.tags.push(tagObject);
                        } else {
                            alert('Maximum 3 tags allowed per milestone');
                            return;
                        }
                    } else {
                        // Editing existing tag
                        milestoneData.tags[parseInt(tagIdx)] = tagObject;
                    }
                    
                    await window.electronAPI.saveCompanies(companiesData);
                    
                    // Update global data to reflect the changes
                    globalCompaniesData = companiesData;
                    
                    // Close modal and refresh the view
                    const modal = bootstrap.Modal.getInstance(tagModal);
                    modal.hide();
                    renderCompanies(document.getElementById('searchCompany').value);
                } finally {
                    // Hide loading spinner
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'none';
                    }
                }
            }
        });

        // Add event listener for the Delete Tag button in modal
        document.getElementById('deleteTag').addEventListener('click', async function() {
            const tagModal = document.getElementById('tagModal');
            const companyId = parseInt(tagModal.dataset.companyId);
            const milestoneId = parseInt(tagModal.dataset.milestoneId);
            const tagIdx = tagModal.dataset.tagIdx;
            
            if (tagIdx !== '' && tagIdx !== undefined) {
                try {
                    const companiesData = await window.electronAPI.getCompanies();
                    const companyData = companiesData.find(c => c.id === companyId);
                    const milestoneData = companyData?.milestones?.find(m => m.id === milestoneId);
                    
                    if (milestoneData && milestoneData.tags) {
                        const index = parseInt(tagIdx);
                        if (index >= 0 && index < milestoneData.tags.length) {
                            milestoneData.tags.splice(index, 1);
                            
                            await window.electronAPI.saveCompanies(companiesData);
                            globalCompaniesData = companiesData;
                            
                            // Close modal and refresh
                            const modal = bootstrap.Modal.getInstance(tagModal);
                            modal.hide();
                            renderCompanies(document.getElementById('searchCompany').value);
                        }
                    }
                } catch (error) {
                    console.error('Error deleting tag:', error);
                    alert('Error deleting tag: ' + error.message);
                }
            }
        });

        // Add event listener for the Quick Tag Save button
        document.getElementById('saveQuickTag').addEventListener('click', async function() {
            const quickTagModal = document.getElementById('quickTagInputModal');
            const companyId = parseInt(quickTagModal.dataset.companyId);
            const milestoneId = parseInt(quickTagModal.dataset.milestoneId);
            const tagText = document.getElementById('quickTagInput').value.trim();
            const selectedColor = document.getElementById('quickSelectedColor').value;
            
            console.log('saveQuickTag: Tag save operation initiated', { 
                companyId, 
                milestoneId, 
                tagText, 
                selectedColor,
                modalData: {
                    companyId: quickTagModal.dataset.companyId,
                    milestoneId: quickTagModal.dataset.milestoneId
                }
            });
            
            if (tagText) {
                console.log('saveQuickTag: Valid tag text provided, proceeding with save');
                
                // Immediately hide the modal
                const modal = bootstrap.Modal.getInstance(quickTagModal);
                modal.hide();
                console.log('saveQuickTag: Modal hidden');
                
                // Find the specific milestone item and show loading spinner, hide add button
                const milestoneItems = document.querySelectorAll('.list-group-item');
                let targetMilestoneItem = null;
                
                milestoneItems.forEach(item => {
                    const addBtn = item.querySelector('.add-tag-btn');
                    if (addBtn && 
                        parseInt(addBtn.dataset.companyId) === companyId && 
                        parseInt(addBtn.dataset.milestoneId) === milestoneId) {
                        targetMilestoneItem = item;
                    }
                });
                
                if (targetMilestoneItem) {
                    const addTagButton = targetMilestoneItem.querySelector('.add-tag-btn');
                    const loadingSpinner = targetMilestoneItem.querySelector('.tag-loading-spinner');
                    
                    if (addTagButton && loadingSpinner) {
                        addTagButton.style.display = 'none';
                        loadingSpinner.style.display = 'block';
                    }
                }
                
                try {
                    const companiesData = await window.electronAPI.getCompanies();
                    const companyData = companiesData.find(c => c.id === companyId);
                    if (!companyData) {
                        console.error('saveQuickTag: Company not found during tag save', { companyId, availableCompanies: companiesData.map(c => c.id) });
                        return;
                    }
                    if (!companyData.milestones) {
                        console.error('saveQuickTag: Company has no milestones', { companyId, companyData });
                        return;
                    }
                    const milestoneData = companyData.milestones.find(m => m.id === milestoneId);
                    if (!milestoneData) {
                        console.error('saveQuickTag: Milestone not found', { 
                            companyId, 
                            milestoneId, 
                            availableMilestones: companyData.milestones.map(m => ({ id: m.id, name: m.name }))
                        });
                        return;
                    }
                    
                    if (!Array.isArray(milestoneData.tags)) {
                        console.log('saveQuickTag: Initializing tags array for milestone', { companyId, milestoneId });
                        milestoneData.tags = [];
                    }
                    
                    console.log('saveQuickTag: Current milestone state', { 
                        companyId, 
                        milestoneId, 
                        milestoneName: milestoneData.name,
                        currentTagsCount: milestoneData.tags.length,
                        maxAllowed: 3
                    });
                    
                    // Adding new tag with selected color
                    if (milestoneData.tags.length < 3) {
                        const tagObject = {
                            text: tagText,
                            color: selectedColor
                        };
                        milestoneData.tags.push(tagObject);
                        
                        console.log('saveQuickTag: Tag added to milestone', { 
                            companyId, 
                            milestoneId, 
                            milestoneName: milestoneData.name,
                            tagObject,
                            newTagsCount: milestoneData.tags.length
                        });
                        
                        await window.electronAPI.saveCompanies(companiesData);
                        console.log('saveQuickTag: Companies data saved successfully');
                        
                        // Update global data to reflect the changes
                        globalCompaniesData = companiesData;
                        
                        // Refresh the view to show the new tag
                        renderCompanies(document.getElementById('searchCompany').value);
                        console.log('saveQuickTag: View refreshed with new tag');
                    } else {
                        console.log('saveQuickTag: Maximum tags limit reached', { 
                            companyId, 
                            milestoneId, 
                            currentTagsCount: milestoneData.tags.length,
                            attemptedTag: { text: tagText, color: selectedColor }
                        });
                        alert('Maximum 3 tags allowed per milestone');
                        // Hide loading spinner and show add button again if there was an error
                        if (targetMilestoneItem) {
                            const addTagButton = targetMilestoneItem.querySelector('.add-tag-btn');
                            const loadingSpinner = targetMilestoneItem.querySelector('.tag-loading-spinner');
                            
                            if (addTagButton && loadingSpinner) {
                                loadingSpinner.style.display = 'none';
                                addTagButton.style.display = 'block';
                            }
                        }
                    }
                } catch (error) {
                    console.error('saveQuickTag: Critical error during tag save operation', { 
                        error: error.message, 
                        stack: error.stack,
                        companyId, 
                        milestoneId, 
                        tagText, 
                        selectedColor,
                        globalDataLength: globalCompaniesData.length
                    });
                    alert('Error adding tag: ' + error.message);
                    
                    // Hide loading spinner and show add button again if there was an error
                    if (targetMilestoneItem) {
                        const addTagButton = targetMilestoneItem.querySelector('.add-tag-btn');
                        const loadingSpinner = targetMilestoneItem.querySelector('.tag-loading-spinner');
                        
                        if (addTagButton && loadingSpinner) {
                            loadingSpinner.style.display = 'none';
                            addTagButton.style.display = 'block';
                        }
                    }
                }
            }
        });

        // Handle Enter key in quick tag input
        document.getElementById('quickTagInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('saveQuickTag').click();
            }
        });

        // Add color selection functionality for quick tag modal
        document.querySelectorAll('.quick-color-option').forEach(colorBtn => {
            colorBtn.addEventListener('click', function() {
                // Remove selected class from all color options
                document.querySelectorAll('.quick-color-option').forEach(btn => {
                    btn.style.border = '2px solid transparent';
                });
                // Add selected class to clicked option
                this.style.border = '2px solid #000';
                document.getElementById('quickSelectedColor').value = this.dataset.color;
            });
        });

        // Reset quick tag modal when it's shown
        document.getElementById('quickTagInputModal').addEventListener('shown.bs.modal', function() {
            // Clear input
            document.getElementById('quickTagInput').value = '';
            // Reset color selection to default
            document.querySelectorAll('.quick-color-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
            });
            const defaultColorBtn = document.querySelector('.quick-color-option[data-color="secondary"]');
            if (defaultColorBtn) {
                defaultColorBtn.style.border = '2px solid #000';
            }
            document.getElementById('quickSelectedColor').value = 'secondary';
            // Focus on input
            setTimeout(() => {
                document.getElementById('quickTagInput').focus();
            }, 100);
        });

        // Add this function to handle sending the email
        async function sendMilestoneEmail(e) {
            const button = e.target;
            const companyId = parseInt(button.dataset.companyId);
            const milestoneId = parseInt(button.dataset.milestoneId);
            const milestoneName = button.dataset.milestoneName;

            const companies = await window.electronAPI.getCompanies();
            const company = companies.find(c => c.id === companyId);

            // Find the specific milestone object
            const milestone = company?.milestones?.find(m => m.id === milestoneId);

            // Load email templates and look for a matching template
            const templates = loadEmailTemplates();
            const matchingTemplate = templates.find(t => t.milestone === milestoneName);

            if (matchingTemplate) {
                // Use the template if found - pass milestone object for additional variables
                const subject = replaceTemplateVariables(matchingTemplate.subject, company, milestoneName, milestone);
                const body = replaceTemplateVariables(matchingTemplate.body, company, milestoneName, milestone);
                const email = company.contactEmail || '';

                // Open email client with template content
                window.electronAPI.openEmailClient(email, subject, encodeURIComponent(body));
            } else {
                // Fall back to default email format if no template found
                const subject = `Milestone Reached: ${milestoneName}`;
                const body = 
                    `Hello${company.contactName ? ' ' + company.contactName : ''},\n\n` +
                    `The milestone "${milestoneName}" has been reached for ${company.address || 'your property'}.\n\n` +
                    `Best regards,\n10 stars property management`;
                const email = company.contactEmail || '';

                // Open default mail client
                window.electronAPI.openEmailClient(email, subject, encodeURIComponent(body));
            }
        }

        // Add this function to handle sending internal emails
        async function sendInternalEmail(e) {
            const button = e.target;
            const companyId = parseInt(button.dataset.companyId);
            const milestoneId = parseInt(button.dataset.milestoneId);
            const milestoneName = button.dataset.milestoneName;

            const companies = await window.electronAPI.getCompanies();
            const company = companies.find(c => c.id === companyId);

            // Find the specific milestone object
            const milestone = company?.milestones?.find(m => m.id === milestoneId);

            // Load internal email templates and look for a matching template
            loadInternalEmailTemplates();
            const matchingTemplate = internalEmailTemplates.find(t => t.milestone === milestoneName);

            if (matchingTemplate) {
                // Use the internal template if found
                const subject = replaceTemplateVariables(matchingTemplate.subject, company, milestoneName, milestone);
                const body = replaceTemplateVariables(matchingTemplate.body, company, milestoneName, milestone);
                let email = matchingTemplate.internalEmail || '';

                // If no default email in template, prompt user
                if (!email) {
                    email = prompt('Enter internal email address(es):') || '';
                }

                // Open email client with template content
                window.electronAPI.openEmailClient(email, subject, encodeURIComponent(body));
            } else {
                // Fall back to default internal email format if no template found
                const subject = `Internal Update: ${milestoneName} - ${company.address || `Company ${company.id}`}`;
                const body = 
                    `Internal Update:\n\n` +
                    `Property: ${company.address || `Company ${company.id}`}\n` +
                    `Contact: ${company.contactName || 'N/A'}\n` +
                    `Milestone: ${milestoneName}\n` +
                    `Status: Completed\n` +
                    `Date: ${new Date().toLocaleDateString()}\n\n` +
                    `Please review and take any necessary follow-up actions.\n\n` +
                    `System Generated - 10 Stars Property Management`;
                
                // Prompt user for email address
                const email = prompt('Enter internal email address(es):') || '';

                // Open default mail client
                window.electronAPI.openEmailClient(email, subject, encodeURIComponent(body));
            }
        }

        // Helper function to check if company passes date filter
        function passesDateFilter(company, dateFrom, dateTo) {
            if (!dateFrom && !dateTo) return true;
            
            const companyDate = new Date(company.createdDate);
            const fromDate = dateFrom ? new Date(dateFrom) : null;
            const toDate = dateTo ? new Date(dateTo) : null;
            
            if (fromDate && companyDate < fromDate) return false;
            if (toDate && companyDate > toDate) return false;
            
            return true;
        }


        async function renderCompanies(searchTerm) {
            try {
                // If searchTerm is undefined, use the current value of the search box
                if (typeof searchTerm === 'undefined') {
                    searchTerm = document.getElementById('searchCompany').value || '';
                }
                
                // Always use global data if available, otherwise load fresh
                let companies;
                if (globalCompaniesData.length > 0) {
                    companies = globalCompaniesData;
                } else {
                    companies = await loadGlobalData();
                }
                
                const list = document.getElementById('companiesList');
                if (!list) {
                    console.error('Could not find companiesList element');
                    return;
                }
                list.innerHTML = '';

            // Get filter values
            const searchFilter = document.getElementById('searchFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            let filteredCompanies = companies.filter(c => {
                const term = (searchTerm || '').trim().toLowerCase();
                
                // If no search term, check date filters only
                if (term === '') {
                    return passesDateFilter(c, dateFrom, dateTo);
                }

                // Apply text search based on selected filter
                let matchesSearch = false;
                switch (searchFilter) {
                    case 'all':
                        matchesSearch = (c.address && c.address.toLowerCase().includes(term)) ||
                                      (c.contactName && c.contactName.toLowerCase().includes(term)) ||
                                      (c.contactEmail && c.contactEmail.toLowerCase().includes(term)) ||
                                      (c.createdDate && c.createdDate.includes(term));
                        break;
                    case 'address':
                        matchesSearch = c.address && c.address.toLowerCase().includes(term);
                        break;
                    case 'contactName':
                        matchesSearch = c.contactName && c.contactName.toLowerCase().includes(term);
                        break;
                    case 'contactEmail':
                        matchesSearch = c.contactEmail && c.contactEmail.toLowerCase().includes(term);
                        break;
                    case 'createdDate':
                        matchesSearch = c.createdDate && c.createdDate.includes(term);
                        break;
                    default:
                        matchesSearch = true;
                }

                return matchesSearch && passesDateFilter(c, dateFrom, dateTo);
            });

            // Apply sorting
            filteredCompanies.sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return new Date(b.createdDate || 0) - new Date(a.createdDate || 0);
                    case 'oldest':
                        return new Date(a.createdDate || 0) - new Date(b.createdDate || 0);
                    case 'address':
                        return (a.address || '').localeCompare(b.address || '');
                    case 'contactName':
                        return (a.contactName || '').localeCompare(b.contactName || '');
                    default:
                        return 0;
                }
            });

            // Update results count
            const resultsCount = document.getElementById('resultsCount');
            const totalCompanies = companies.length;
            const filteredCount = filteredCompanies.length;
            
            if (filteredCount === totalCompanies) {
                resultsCount.textContent = `Showing all ${totalCompanies} companies`;
            } else {
                resultsCount.textContent = `Showing ${filteredCount} of ${totalCompanies} companies`;
            }

            // Show all filtered companies (performance issues resolved)
            const limitedCompanies = filteredCompanies;
            
            limitedCompanies.forEach(company => {
                    const isMinimized = minimizedCompanies[company.id];

                    const card = document.createElement('div');
                    card.className = 'card mb-4 col-12 border-0 shadow-sm company-card';

                    // Modern header with gradient and icon
                    card.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom-0 rounded-top-4" style="background: linear-gradient(90deg, #e3f2fd 0%, #fff 100%);">
                            <div>
                                <h5 class="mb-0 fw-bold text-primary">${company.address || '<span class=\"text-muted\">No address</span>'}</h5>
                                <small class="text-muted">${company.contactName ? `(${company.contactName})` : ''}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary minimize-btn me-2" data-company-id="${company.id}">
                                    <i class="bi ${isMinimized ? 'bi-chevron-down' : 'bi-chevron-up'}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-company-btn" data-company-id="${company.id}">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body px-4 py-3 bg-light rounded-bottom-4" style="${isMinimized ? 'display:none;' : ''}">
                            <div class="row mb-2">
                                <div class="col-md-6"><span class="fw-semibold text-secondary">Project Created date:</span> ${company.createdDate ? new Date(company.createdDate).toLocaleDateString() : '<span class="text-muted">N/A</span>'}</div>
                                <div class="col-md-6"><span class="fw-semibold text-secondary">Email:</span> ${company.contactEmail || '<span class="text-muted">N/A</span>'}</div>
                            </div>
                            <div>
                                <h6 class="fw-bold text-info mb-3">Milestones</h6>
                                <ul class="list-group list-group-flush" id="milestones-${company.id}"></ul>
                            </div>
                        </div>
                    `;

                    // Add milestones checklist - Show only first 10 critical milestones for performance
                    const milestonesList = card.querySelector(`#milestones-${company.id}`);
                    const defaultMilestones = [
                        { id: 1, name: 'Keys', completed: false },
                        { id: 2, name: 'Power', completed: false },
                        { id: 3, name: 'Water', completed: false },
                        { id: 4, name: 'Deposit held', completed: false },
                        { id: 5, name: 'Balance', completed: false },
                        { id: 6, name: 'Move-out', completed: false },
                        { id: 7, name: 'Quote', completed: false },
                        { id: 8, name: 'Contact owner', completed: false },
                        { id: 9, name: 'Email inspection video + quote', completed: false },
                        { id: 10, name: 'Follow up date', completed: false }
                    ];
                    const milestones = company.milestones && company.milestones.length > 0
                        ? company.milestones // Show all milestones (limit removed)
                        : defaultMilestones;

                    milestones.forEach(milestone => {
                        const milestoneItem = document.createElement('li');
                        milestoneItem.className = 'list-group-item d-flex align-items-center justify-content-between bg-white border-0 rounded-3 mb-2 shadow-sm';
                        
                        // Create tags HTML
                        let tagsHtml = '';
                        if (milestone.tags && Array.isArray(milestone.tags) && milestone.tags.length > 0) {
                            tagsHtml = milestone.tags.slice(0, 3).map((tag, index) => 
                                `<span class="badge bg-${tag.color || 'secondary'} me-1 tag-item" 
                                    style="cursor: pointer; position: relative; padding: 6px 10px; font-size: 13px;" 
                                    data-company-id="${company.id}" 
                                    data-milestone-id="${milestone.id}" 
                                    data-tag-index="${index}"
                                    title="Click to edit or delete tag">
                                    ${tag.text}
                                    <i class="bi bi-x-circle ms-1" style="font-size: 0.9em;"></i>
                                </span>`
                            ).join('');
                        }

                        // Add tag button (always show if less than 3 tags)
                        const canAddTags = !milestone.tags || milestone.tags.length < 3;
                        const addTagHtml = canAddTags ? 
                            `<button class="btn btn-sm btn-light add-tag-btn me-2" 
                                data-company-id="${company.id}" 
                                data-milestone-id="${milestone.id}" 
                                data-milestone-name="${milestone.name}">
                                <i class="bi bi-plus"></i> Tag
                            </button>
                            <div class="spinner-border spinner-border-sm tag-loading-spinner me-2" style="display: none;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>` : '';

                        milestoneItem.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="position-relative me-2" style="min-width: 20px; min-height: 20px;">
                                    <input type="checkbox" class="form-check-input" ${milestone.completed ? 'checked' : ''} 
                                        data-company-id="${company.id}" data-milestone-id="${milestone.id}">
                                    <div class="spinner-border spinner-border-sm milestone-loading-spinner" 
                                        style="display: none; position: absolute; top: 0; left: 0; width: 16px; height: 16px;" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <span class="fw-semibold ${milestone.completed ? 'text-success' : 'text-dark'}">${milestone.name}</span>
                                <div class="ms-3" style="width: 140px; min-height: 31px; display: flex; align-items: center;">
                                    <input type="date" class="form-control form-control-sm milestone-date-input" 
                                        style="width: 100%; ${milestone.completed ? '' : 'visibility: hidden;'}" 
                                        value="${milestone.completedDate || ''}" 
                                        data-company-id="${company.id}" data-milestone-id="${milestone.id}">
                                </div>
                                <div class="ms-2 d-flex align-items-center flex-wrap">${tagsHtml}</div>
                            </div>
                            <div class="d-flex align-items-center">
                                ${addTagHtml}
                                <button class="btn btn-sm btn-outline-info send-email-btn me-2"
                                    data-company-id="${company.id}"
                                    data-milestone-id="${milestone.id}"
                                    data-milestone-name="${milestone.name}">
                                    <i class="bi bi-envelope"></i> Email
                                </button>
                                <button class="btn btn-sm btn-outline-warning send-internal-email-btn me-2"
                                    data-company-id="${company.id}"
                                    data-milestone-id="${milestone.id}"
                                    data-milestone-name="${milestone.name}">
                                    <i class="bi bi-envelope-check"></i> Internal
                                </button>
                            </div>
                        `;
                        milestonesList.appendChild(milestoneItem);

                        // Add checkbox event listener to use the improved toggleMilestone function
                        milestoneItem.querySelector('input[type="checkbox"]').addEventListener('change', toggleMilestone);

                        // Add tag button event
                        const addTagBtn = milestoneItem.querySelector('.add-tag-btn');
                        if (addTagBtn) {
                            addTagBtn.addEventListener('click', function(e) {
                                const button = e.target.closest('.add-tag-btn');
                                const companyId = parseInt(button.dataset.companyId);
                                const milestoneId = parseInt(button.dataset.milestoneId);
                                const milestoneName = button.dataset.milestoneName;

                                // Set modal data
                                const quickTagModal = document.getElementById('quickTagInputModal');
                                quickTagModal.dataset.companyId = companyId;
                                quickTagModal.dataset.milestoneId = milestoneId;
                                
                                // Set modal title
                                document.getElementById('quickTagModalLabel').textContent = `Add Tag to: ${milestoneName}`;
                                
                                const modal = new bootstrap.Modal(quickTagModal);
                                modal.show();
                            });
                        }
                        
                        // Email button events
                        milestoneItem.querySelector('.send-email-btn').addEventListener('click', sendMilestoneEmail);
                        milestoneItem.querySelector('.send-internal-email-btn').addEventListener('click', sendInternalEmail);

                        // Simple date input event
                        milestoneItem.querySelector('.milestone-date-input').addEventListener('change', function(e) {
                            updateMilestone(company.id, milestone.id, { completedDate: e.target.value });
                        });

                        // Add event listeners for clickable tags
                        const tagItems = milestoneItem.querySelectorAll('.tag-item');
                        tagItems.forEach(tagItem => {
                            tagItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // Remove any existing tag popup
                                document.querySelectorAll('.tag-popup').forEach(popup => popup.remove());
                                
                                const companyId = parseInt(this.dataset.companyId);
                                const milestoneId = parseInt(this.dataset.milestoneId);
                                const tagIndex = parseInt(this.dataset.tagIndex);
                                
                                // Find the milestone and tag data
                                const company = globalCompaniesData.find(c => c.id === companyId);
                                if (!company || !company.milestones) return;
                                
                                const milestone = company.milestones.find(m => m.id === milestoneId);
                                if (!milestone || !milestone.tags || !milestone.tags[tagIndex]) return;
                                
                                const tag = milestone.tags[tagIndex];
                                
                                // Create popup overlay
                                const popup = document.createElement('div');
                                popup.className = 'tag-popup';
                                popup.style.cssText = `
                                    position: absolute;
                                    background: white;
                                    border: 2px solid #dee2e6;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                    padding: 8px;
                                    z-index: 1000;
                                    display: flex;
                                    gap: 4px;
                                    min-width: 120px;
                                `;
                                
                                // Position popup above the tag
                                const rect = this.getBoundingClientRect();
                                popup.style.left = (rect.left + window.scrollX) + 'px';
                                popup.style.top = (rect.top + window.scrollY - 50) + 'px';
                                
                                // Create edit button
                                const editBtn = document.createElement('button');
                                editBtn.className = 'btn btn-sm btn-outline-primary';
                                editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
                                editBtn.style.fontSize = '11px';
                                editBtn.style.padding = '4px 8px';
                                
                                // Create delete button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-sm btn-outline-danger';
                                deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
                                deleteBtn.style.fontSize = '11px';
                                deleteBtn.style.padding = '4px 8px';
                                
                                popup.appendChild(editBtn);
                                popup.appendChild(deleteBtn);
                                document.body.appendChild(popup);
                                
                                // Edit button click handler
                                editBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    popup.remove();
                                    
                                    // Open tag modal with existing data
                                    const tagModal = document.getElementById('tagModal');
                                    tagModal.dataset.companyId = companyId;
                                    tagModal.dataset.milestoneId = milestoneId;
                                    tagModal.dataset.tagIdx = tagIndex;
                                    
                                    // Pre-fill the form with existing tag data
                                    document.getElementById('tagInput').value = tag.text;
                                    document.getElementById('selectedColor').value = tag.color || 'secondary';
                                    
                                    // Reset color selection and set the current color
                                    document.querySelectorAll('.color-option').forEach(btn => {
                                        btn.style.border = '2px solid transparent';
                                    });
                                    const currentColorBtn = document.querySelector(`.color-option[data-color="${tag.color || 'secondary'}"]`);
                                    if (currentColorBtn) {
                                        currentColorBtn.style.border = '2px solid #000';
                                    }
                                    
                                    // Show delete button in modal since we're editing
                                    document.getElementById('deleteTag').style.display = 'block';
                                    
                                    const modal = new bootstrap.Modal(tagModal);
                                    modal.show();
                                });
                                
                                // Delete button click handler
                                deleteBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    popup.remove();
                                    
                                    // Remove the tag without confirmation
                                    milestone.tags.splice(tagIndex, 1);
                                    
                                    // Save and refresh
                                    window.electronAPI.saveCompanies(globalCompaniesData).then(() => {
                                        renderCompanies(document.getElementById('searchCompany').value);
                                    }).catch(error => {
                                        console.error('Error deleting tag:', error);
                                        alert('Error deleting tag: ' + error.message);
                                    });
                                });
                                
                                // Close popup when clicking outside
                                setTimeout(() => {
                                    document.addEventListener('click', function closePopup(e) {
                                        if (!popup.contains(e.target)) {
                                            popup.remove();
                                            document.removeEventListener('click', closePopup);
                                        }
                                    });
                                }, 100);
                            });
                        });
                    });

                    list.appendChild(card);

                    // Minimize button event
                    card.querySelector('.minimize-btn').addEventListener('click', function() {
                        minimizedCompanies[company.id] = !minimizedCompanies[company.id];
                        renderCompanies(searchTerm);
                    });

                    // Delete button event
                    card.querySelector('.delete-company-btn').addEventListener('click', async function() {
                        const companyName = company.address || `Company ${company.id}`;
                        if (confirm(`Are you sure you want to delete "${companyName}"? This action cannot be undone.`)) {
                            try {
                                // Remove from global state
                                const updatedCompanies = globalCompaniesData.filter(c => c.id !== company.id);
                                
                                // Save to database
                                await window.electronAPI.saveCompanies(updatedCompanies);
                                
                                // Update global state
                                globalCompaniesData = updatedCompanies;
                                
                                // Clear search and refresh the list
                                document.getElementById('searchCompany').value = "";
                                await renderCompanies('');
                                
                                // Update charts
                                updateChartsIfVisible();
                                
                            } catch (error) {
                                console.error('Failed to delete company:', error.message);
                                alert('Error deleting project: ' + error.message);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error in renderCompanies:', error);
                const list = document.getElementById('companiesList');
                if (list) {
                    list.innerHTML = '<div class="alert alert-danger">Error loading companies. Please refresh the page.</div>';
                }
            }
        }

        // Email Templates functionality
        let emailTemplates = [];
        let currentEditingTemplate = null;

        // Internal Email Templates functionality
        let internalEmailTemplates = [];
        let currentEditingInternalTemplate = null;

        // Load email templates from localStorage
        function loadEmailTemplates() {
            const saved = localStorage.getItem('emailTemplates');
            let templates = saved ? JSON.parse(saved) : getDefaultTemplates();
            
            // Migration: Ensure internal templates exist
            const internalTemplateIds = [31, 32, 33, 34, 35];
            const hasInternalTemplates = templates.some(t => internalTemplateIds.includes(t.id));
            
            if (!hasInternalTemplates) {
                // Add internal templates to existing templates
                const defaultTemplates = getDefaultTemplates();
                const internalTemplates = defaultTemplates.filter(t => t.type === 'internal');
                templates = [...templates, ...internalTemplates];
                
                // Save updated templates
                localStorage.setItem('emailTemplates', JSON.stringify(templates));
            }
            
            emailTemplates = templates;
            return emailTemplates;
        }

        // Save email templates to localStorage
        function saveEmailTemplates() {
            localStorage.setItem('emailTemplates', JSON.stringify(emailTemplates));
        }

        // Get default email templates
        function getDefaultTemplates() {
            const templates = [
                {
                    id: 1,
                    name: "Keys Complete",
                    milestone: "Keys",
                    type: "external",
                    subject: "Keys Ready - {address}",
                    body: "Hello {contactName},\n\nGreat news! The keys are now ready for {address}.\n\nThe Keys milestone has been completed successfully on {currentDate}.\n\nPlease let us know when you'd like to schedule pickup.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 2,
                    name: "Power Connected",
                    milestone: "Power",
                    type: "external",
                    subject: "Power Connected - {address}",
                    body: "Hello {contactName},\n\nThe power has been successfully connected at {address}.\n\nThis milestone was completed on {currentDate}.\n\nWe're making great progress on your property!\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 3,
                    name: "Water Service Active",
                    milestone: "Water",
                    type: "external",
                    subject: "Water Service Activated - {address}",
                    body: "Hello {contactName},\n\nWater service has been successfully activated at {address}.\n\nCompleted on {currentDate}.\n\nYour property is now ready for the next phase.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 4,
                    name: "Deposit Received",
                    milestone: "Deposit held",
                    type: "external",
                    subject: "Deposit Received - {address}",
                    body: "Hello {contactName},\n\nWe have successfully received and processed your deposit for {address}.\n\nDeposit secured on {currentDate}.\n\nWe can now proceed with the next steps of your project.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 5,
                    name: "Balance Payment",
                    milestone: "Balance",
                    type: "external",
                    subject: "Balance Payment Due - {address}",
                    body: "Hello {contactName},\n\nThe balance payment is now due for {address}.\n\nPlease process the remaining balance to continue with your project.\n\nPayment processed on {currentDate}.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 6,
                    name: "Move-out Complete",
                    milestone: "Move-out",
                    type: "external",
                    subject: "Move-out Process Complete - {address}",
                    body: "Hello {contactName},\n\nThe move-out process has been completed for {address}.\n\nCompleted on {currentDate}.\n\nWe can now begin preparing the property for rehabilitation.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 7,
                    name: "Quote Provided",
                    milestone: "Quote",
                    type: "external",
                    subject: "Quote Ready - {address}",
                    body: "Hello {contactName},\n\nYour quote for {address} is now ready for review.\n\nQuote prepared on {currentDate}.\n\nPlease review and let us know if you have any questions.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 8,
                    name: "Owner Contacted",
                    milestone: "Contact owner",
                    type: "external",
                    subject: "Owner Contact Completed - {address}",
                    body: "Hello {contactName},\n\nWe have successfully contacted the owner regarding {address}.\n\nContact made on {currentDate}.\n\nWe'll keep you updated on any developments.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 9,
                    name: "Inspection Video Sent",
                    milestone: "Email inspection video + quote",
                    type: "external",
                    subject: "Inspection Video & Quote - {address}",
                    body: "Hello {contactName},\n\nPlease find attached the inspection video and quote for {address}.\n\nSent on {currentDate}.\n\nReview the materials and let us know if you need any clarification.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 10,
                    name: "Follow-up Scheduled",
                    milestone: "Follow up date",
                    type: "external",
                    subject: "Follow-up Scheduled - {address}",
                    body: "Hello {contactName},\n\nA follow-up has been scheduled for {address}.\n\nScheduled on {currentDate}.\n\nWe'll be in touch with updates soon.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 11,
                    name: "Project Approved",
                    milestone: "Approval",
                    type: "external",
                    subject: "Project Approved - {address}",
                    body: "Hello {contactName},\n\nGreat news! Your project for {address} has been approved.\n\nApproval received on {currentDate}.\n\nWe can now move forward with the next steps.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 12,
                    name: "Funds Secured",
                    milestone: "Funds",
                    type: "external",
                    subject: "Funds Secured - {address}",
                    body: "Hello {contactName},\n\nThe necessary funds have been secured for {address}.\n\nFunds confirmed on {currentDate}.\n\nYour project is now financially ready to proceed.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 13,
                    name: "Materials Ordered",
                    milestone: "Order of materials",
                    type: "external",
                    subject: "Materials Ordered - {address}",
                    body: "Hello {contactName},\n\nAll necessary materials have been ordered for {address}.\n\nOrder placed on {currentDate}.\n\nWe'll notify you when materials arrive and work can begin.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 14,
                    name: "Prebill Processed",
                    milestone: "Prebill",
                    type: "external",
                    subject: "Prebill Processed - {address}",
                    body: "Hello {contactName},\n\nThe prebill for {address} has been processed.\n\nProcessed on {currentDate}.\n\nPlease review the prebill details and contact us with any questions.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 15,
                    name: "Added to Wait List",
                    milestone: "Wait list",
                    type: "external",
                    subject: "Added to Wait List - {address}",
                    body: "Hello {contactName},\n\nYour property at {address} has been added to our priority wait list.\n\nAdded on {currentDate}.\n\nWe'll notify you as soon as we can begin work.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 16,
                    name: "Rehab Started",
                    milestone: "Rehab start",
                    type: "external",
                    subject: "Rehabilitation Started - {address}",
                    body: "Hello {contactName},\n\nWe're excited to announce that rehabilitation work has begun on {address}.\n\nWork started on {currentDate}.\n\nOur team is committed to delivering excellent results.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 17,
                    name: "Add-ons Completed",
                    milestone: "Add ons",
                    type: "external",
                    subject: "Additional Work Completed - {address}",
                    body: "Hello {contactName},\n\nAll additional work has been completed for {address}.\n\nCompleted on {currentDate}.\n\nYour property enhancements are now finished.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 18,
                    name: "Rehab Complete",
                    milestone: "Rehab ends",
                    type: "external",
                    subject: "Rehabilitation Complete - {address}",
                    body: "Hello {contactName},\n\nWe're pleased to announce that all rehabilitation work at {address} has been completed.\n\nWork finished on {currentDate}.\n\nYour property is now ready for the final steps.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 19,
                    name: "Cleanup Complete",
                    milestone: "Dump and pick up material left on site",
                    type: "external",
                    subject: "Site Cleanup Complete - {address}",
                    body: "Hello {contactName},\n\nAll materials have been removed and site cleanup is complete at {address}.\n\nCompleted on {currentDate}.\n\nYour property is now clean and ready.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 20,
                    name: "Vendor Coordination",
                    milestone: "Vendor?",
                    type: "external",
                    subject: "Vendor Coordination Update - {address}",
                    body: "Hello {contactName},\n\nVendor coordination for {address} has been completed.\n\nCoordinated on {currentDate}.\n\nAll necessary vendor work is now arranged.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 21,
                    name: "Cleaning Complete",
                    milestone: "Cleaning",
                    type: "external",
                    subject: "Property Cleaning Complete - {address}",
                    body: "Hello {contactName},\n\nProfessional cleaning has been completed at {address}.\n\nCleaning finished on {currentDate}.\n\nYour property is now spotless and move-in ready.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 22,
                    name: "Quality Control Complete",
                    milestone: "Quality control -final walkthrough",
                    type: "external",
                    subject: "Final Quality Control Complete - {address}",
                    body: "Hello {contactName},\n\nOur final quality control walkthrough has been completed for {address}.\n\nWalkthrough completed on {currentDate}.\n\nEverything meets our high standards and is ready.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 23,
                    name: "Final Inspection",
                    milestone: "Final inspection",
                    type: "external",
                    subject: "Final Inspection Complete - {address}",
                    body: "Hello {contactName},\n\nThe final inspection for {address} has passed successfully.\n\nInspection completed on {currentDate}.\n\nYour property is now officially ready for occupancy.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 24,
                    name: "Lawn Care Setup",
                    milestone: "Open recurring task lawn care",
                    type: "external",
                    subject: "Lawn Care Service Activated - {address}",
                    body: "Hello {contactName},\n\nRecurring lawn care service has been set up for {address}.\n\nService activated on {currentDate}.\n\nYour property will be maintained with regular lawn care.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 25,
                    name: "Move-in Inspection",
                    milestone: "Move in inspection",
                    type: "external",
                    subject: "Move-in Inspection Complete - {address}",
                    body: "Hello {contactName},\n\nThe move-in inspection for {address} has been completed.\n\nInspection completed on {currentDate}.\n\nEverything is ready for your tenant to move in.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 26,
                    name: "Billing Assigned",
                    milestone: "Assign all rehab tasks to bill",
                    type: "external",
                    subject: "Billing Tasks Assigned - {address}",
                    body: "Hello {contactName},\n\nAll rehabilitation tasks have been assigned to billing for {address}.\n\nAssigned on {currentDate}.\n\nYour final billing will be processed shortly.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 27,
                    name: "Video Uploaded",
                    milestone: "Video upload",
                    type: "external",
                    subject: "Property Video Uploaded - {address}",
                    body: "Hello {contactName},\n\nThe property video for {address} has been uploaded and is ready for viewing.\n\nUploaded on {currentDate}.\n\nYou can now review the completed work online.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 28,
                    name: "Utilities Disconnected",
                    milestone: "Turn off utilities",
                    type: "external",
                    subject: "Utilities Disconnected - {address}",
                    body: "Hello {contactName},\n\nUtilities have been properly disconnected at {address}.\n\nDisconnected on {currentDate}.\n\nThis completes the utility management for your property.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 29,
                    name: "Property Listed",
                    milestone: "List property",
                    type: "external",
                    subject: "Property Now Listed - {address}",
                    body: "Hello {contactName},\n\nYour property at {address} has been successfully listed for rent.\n\nListed on {currentDate}.\n\nWe'll begin marketing to find qualified tenants.\n\nBest regards,\n10 Stars Property Management"
                },
                {
                    id: 30,
                    name: "Billing Finalized",
                    milestone: "Billing finalized",
                    type: "external",
                    subject: "Project Complete & Billing Finalized - {address}",
                    body: "Hello {contactName},\n\nWe're excited to announce that your project at {address} is now complete!\n\nAll billing has been finalized on {currentDate}.\n\nThank you for choosing 10 Stars Property Management. We look forward to serving you again.\n\nBest regards,\n10 Stars Property Management"
                },
                // Internal Templates
                {
                    id: 31,
                    name: "Keys Internal Update",
                    milestone: "Keys",
                    type: "internal",
                    internalEmail: "manager@10starshomes.com",
                    subject: "Keys Milestone Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nClient: {contactName}\nMilestone: Keys completed\nCompleted: {currentDate}\n\nNext Actions:\n- Notify client of key availability\n- Schedule key pickup\n- Update project status\n\nProject ID: {companyId}\nDays Since Start: {daysSinceStart}"
                },
                {
                    id: 32,
                    name: "Power Internal Update",
                    milestone: "Power",
                    type: "internal",
                    internalEmail: "manager@10starshomes.com",
                    subject: "Power Connection Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nClient: {contactName}\nMilestone: Power connection completed\nCompleted: {currentDate}\n\nNext Actions:\n- Verify power is stable\n- Notify client of completion\n- Proceed to next milestone\n\nProject ID: {companyId}\nDays Since Start: {daysSinceStart}"
                },
                {
                    id: 33,
                    name: "Rehab Start Internal",
                    milestone: "Rehab start",
                    type: "internal",
                    internalEmail: "manager@10starshomes.com",
                    subject: "Rehab Work Started - {address}",
                    body: "Team Update:\n\nProperty: {address}\nClient: {contactName}\nMilestone: Rehabilitation work has begun\nStarted: {currentDate}\n\nNext Actions:\n- Monitor daily progress\n- Ensure materials are available\n- Update client on milestones\n- Schedule inspections\n\nProject ID: {companyId}\nDays Since Start: {daysSinceStart}"
                },
                {
                    id: 34,
                    name: "Final Inspection Internal",
                    milestone: "Final inspection",
                    type: "internal",
                    internalEmail: "manager@10starshomes.com",
                    subject: "Final Inspection Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nClient: {contactName}\nMilestone: Final inspection passed\nCompleted: {currentDate}\n\nNext Actions:\n- Process final billing\n- Schedule client walkthrough\n- Prepare property handover\n- Update property listing\n\nProject ID: {companyId}\nDays Since Start: {daysSinceStart}"
                },
                {
                    id: 35,
                    name: "Project Complete Internal",
                    milestone: "Billing finalized",
                    type: "internal",
                    internalEmail: "manager@10starshomes.com",
                    subject: "Project Complete - {address}",
                    body: "Team Update:\n\nProperty: {address}\nClient: {contactName}\nMilestone: Project complete, billing finalized\nCompleted: {currentDate}\n\nNext Actions:\n- Archive project files\n- Send client satisfaction survey\n- Update client for future opportunities\n- Document lessons learned\n\nProject ID: {companyId}\nTotal Duration: {daysSinceStart} days"
                }
            ];
            
            // Ensure all external templates have type field for backward compatibility
            return templates.map(template => ({
                ...template,
                type: template.type || 'external'
            }));
        }

        // Populate milestone dropdown in template editor
        function populateMilestoneDropdown() {
            const milestoneSelect = document.getElementById('templateMilestone');
            
            // Clear existing options
            milestoneSelect.innerHTML = '<option value="">Select milestone (optional)</option>';
            
            // Get unique milestones from companies data
            const milestones = new Set();
            globalCompaniesData.forEach(company => {
                company.milestones?.forEach(milestone => {
                    milestones.add(milestone.name);
                });
            });
            
            // Add milestone options
            Array.from(milestones).sort().forEach(milestone => {
                const option = document.createElement('option');
                option.value = milestone;
                option.textContent = milestone;
                milestoneSelect.appendChild(option);
            });
        }

        // Render templates list
        function renderTemplatesList(searchTerm = '') {
            const templatesList = document.getElementById('templatesList');
            templatesList.innerHTML = '';

            // Filter templates based on search term
            const filteredTemplates = emailTemplates.filter(template => {
                if (!searchTerm.trim()) return true;
                const searchLower = searchTerm.toLowerCase().trim();
                return template.name.toLowerCase().includes(searchLower) ||
                       (template.milestone && template.milestone.toLowerCase().includes(searchLower));
            });

            if (filteredTemplates.length === 0) {
                templatesList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No templates found</p>
                        <small>${searchTerm ? 'Try a different search term' : 'Add a new template to get started'}</small>
                    </div>
                `;
                return;
            }

            filteredTemplates.forEach(template => {
                const templateItem = document.createElement('div');
                templateItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                
                const templateType = template.type || 'external';
                const typeIcon = templateType === 'internal' ? 'bi-building' : 'bi-envelope';
                const typeText = templateType === 'internal' ? 'Internal' : 'External';
                const typeColor = templateType === 'internal' ? 'text-warning' : 'text-primary';
                
                templateItem.innerHTML = `
                    <div>
                        <div class="fw-bold">
                            ${template.name}
                            <span class="badge bg-light text-dark ms-2">
                                <i class="bi ${typeIcon} ${typeColor}"></i> ${typeText}
                            </span>
                        </div>
                        <small class="text-muted">${template.milestone ? `For: ${template.milestone}` : 'General template'}</small>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                `;
                
                templateItem.addEventListener('click', () => editTemplate(template));
                templatesList.appendChild(templateItem);
            });
        }

        // Edit template
        function editTemplate(template) {
            currentEditingTemplate = template;
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateMilestone').value = template.milestone || '';
            document.getElementById('templateType').value = template.type || 'external';
            document.getElementById('templateSubject').value = template.subject;
            document.getElementById('templateBody').value = template.body;
            
            // Handle internal email field
            const internalEmailField = document.getElementById('internalEmailField');
            if (template.type === 'internal') {
                internalEmailField.style.display = 'block';
                document.getElementById('templateInternalEmail').value = template.internalEmail || '';
            } else {
                internalEmailField.style.display = 'none';
            }
            
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('templateEditor').style.display = 'block';
        }

        // Cancel edit
        function cancelEdit() {
            currentEditingTemplate = null;
            document.getElementById('templateForm').reset();
            document.getElementById('templateEditor').style.display = 'none';
            document.getElementById('welcomeMessage').style.display = 'block';
            // Hide internal email field when canceling
            document.getElementById('internalEmailField').style.display = 'none';
        }

        // Save template
        function saveTemplate(formData) {
            const template = {
                id: currentEditingTemplate ? currentEditingTemplate.id : Date.now(),
                name: formData.get('templateName'),
                milestone: formData.get('templateMilestone'),
                type: formData.get('templateType') || 'external',
                subject: formData.get('templateSubject'),
                body: formData.get('templateBody')
            };
            
            // Add internal email field if it's an internal template
            if (template.type === 'internal') {
                template.internalEmail = formData.get('templateInternalEmail') || '';
            }

            if (currentEditingTemplate) {
                const index = emailTemplates.findIndex(t => t.id === currentEditingTemplate.id);
                emailTemplates[index] = template;
            } else {
                emailTemplates.push(template);
            }

            saveEmailTemplates();
            renderTemplatesList();
            cancelEdit();
        }

        // Replace variables in template
        function replaceTemplateVariables(text, company, milestoneName, milestone = null) {
            const currentDate = new Date().toLocaleDateString();
            const currentTime = new Date().toLocaleTimeString();
            const currentDateTime = new Date().toLocaleString();
            
            // Get milestone completion date if available
            let milestoneCompletedDate = '';
            let milestoneCompletedTime = '';
            let milestoneCompletedDateTime = '';
            
            if (milestone && milestone.completedDate) {
                const completedDate = new Date(milestone.completedDate);
                milestoneCompletedDate = completedDate.toLocaleDateString();
                milestoneCompletedTime = completedDate.toLocaleTimeString();
                milestoneCompletedDateTime = completedDate.toLocaleString();
            }
            
            // Get project creation date
            let projectCreatedDate = '';
            if (company.createdDate) {
                projectCreatedDate = new Date(company.createdDate).toLocaleDateString();
            }
            
            // Calculate days since project started
            let daysSinceStart = '';
            if (company.createdDate) {
                const startDate = new Date(company.createdDate);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                daysSinceStart = diffDays.toString();
            }
            
            return text
                .replace(/\{contactName\}/g, company.contactName || 'there')
                .replace(/\{contactEmail\}/g, company.contactEmail || 'your email')
                .replace(/\{address\}/g, company.address || 'your property')
                .replace(/\{milestoneName\}/g, milestoneName)
                .replace(/\{currentDate\}/g, currentDate)
                .replace(/\{currentTime\}/g, currentTime)
                .replace(/\{currentDateTime\}/g, currentDateTime)
                .replace(/\{milestoneCompletedDate\}/g, milestoneCompletedDate)
                .replace(/\{milestoneCompletedTime\}/g, milestoneCompletedTime)
                .replace(/\{milestoneCompletedDateTime\}/g, milestoneCompletedDateTime)
                .replace(/\{projectCreatedDate\}/g, projectCreatedDate)
                .replace(/\{daysSinceStart\}/g, daysSinceStart)
                .replace(/\{companyName\}/g, company.address || 'your property') // Using address as company identifier
                .replace(/\{companyId\}/g, company.id?.toString() || '');
        }

        // Show email templates modal for a specific milestone
        function showEmailTemplatesModal(companyId, milestoneId, milestoneName) {
            const modal = new bootstrap.Modal(document.getElementById('emailTemplatesModal'));
            
            // Load and render templates
            loadEmailTemplates();
            populateMilestoneDropdown();
            renderTemplatesList();
            
            // Store current milestone context for template usage
            modal._currentContext = { companyId, milestoneId, milestoneName };
            
            modal.show();
        }

        // Use template to send email
        async function useTemplateForEmail(template, companyId, milestoneName) {
            const companies = await window.electronAPI.getCompanies();
            const company = companies.find(c => c.id === companyId);
            
            if (!company) {
                alert('Company not found!');
                return;
            }

            const subject = replaceTemplateVariables(template.subject, company, milestoneName);
            const body = replaceTemplateVariables(template.body, company, milestoneName);
            const email = company.contactEmail || '';

            // Close the templates modal
            bootstrap.Modal.getInstance(document.getElementById('emailTemplatesModal')).hide();

            // Open email client
            window.electronAPI.openEmailClient(email, subject, encodeURIComponent(body));
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded event started');
            document.getElementById('searchCompany').value = "";
            minimizedCompanies = {};
            
            // Initialize charts
            console.log('Initializing charts...');
            initializeCharts();
            
            // Check Google Sheets status
            await checkSheetsStatus();
            
            try {
                // Load companies and update global state
                globalCompaniesData = await window.electronAPI.getCompanies();
                
                globalCompaniesData.forEach(company => {
                    minimizedCompanies[company.id] = true; // Show details by default
                });
                await renderCompanies(''); // <-- Show all companies!
                
                // Update charts with the loaded data
                updateChartsIfVisible();
                
                console.log('Application initialization completed successfully');
            } catch (error) {
                console.error('Failed to load companies during initialization:', error.message);
            }

            // Initialize Email Templates
            console.log('Initializing email templates...');
            loadEmailTemplates();
            console.log('Loading milestone dropdown...');
            populateMilestoneDropdown();

            // Email Templates Event Listeners
            console.log('Adding email templates event listeners...');
            
            try {
                console.log('Adding cancelEdit listener...');
                document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
                console.log('cancelEdit listener added successfully');
            } catch (error) {
                console.error('Error adding cancelEdit listener:', error);
            }
            
            try {
                console.log('Adding closeTemplateEditor listener...');
                document.getElementById('closeTemplateEditor').addEventListener('click', cancelEdit);
                console.log('closeTemplateEditor listener added successfully');
            } catch (error) {
                console.error('Error adding closeTemplateEditor listener:', error);
            }
            
            try {
                console.log('Adding resetToDefaults listener...');
                document.getElementById('resetToDefaults').addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset all templates to defaults? This will remove any custom templates you created.')) {
                        localStorage.removeItem('emailTemplates');
                        loadEmailTemplates();
                        renderTemplatesList();
                    }
                });
                console.log('resetToDefaults listener added successfully');
            } catch (error) {
                console.error('Error adding resetToDefaults listener:', error);
            }
            
            // Template form submission
            try {
                console.log('Adding templateForm listener...');
                document.getElementById('templateForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    saveTemplate(formData);
                });
                console.log('templateForm listener added successfully');
            } catch (error) {
                console.error('Error adding templateForm listener:', error);
            }

            // Preview template functionality
            document.getElementById('previewTemplate').addEventListener('click', function() {
                const name = document.getElementById('templateName').value;
                const subject = document.getElementById('templateSubject').value;
                const body = document.getElementById('templateBody').value;
                
                if (!name || !subject || !body) {
                    alert('Please fill in all required fields before previewing.');
                    return;
                }

                // Sample company data for preview
                const sampleCompany = { 
                    contactName: 'John Doe', 
                    contactEmail: 'john.doe@example.com',
                    address: '123 Main St, City, State',
                    createdDate: '2024-01-15',
                    id: 1
                };
                const sampleMilestone = 'Keys';
                const sampleMilestoneObj = {
                    completedDate: new Date().toISOString(),
                    completed: true
                };

                try {
                    const previewSubject = replaceTemplateVariables(subject, sampleCompany, sampleMilestone, sampleMilestoneObj);
                    const previewBody = replaceTemplateVariables(body, sampleCompany, sampleMilestone, sampleMilestoneObj);
                    
                    const previewWindow = window.open('', '_blank', 'width=600,height=500');
                    previewWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Email Template Preview</title>
                            <style>
                                body { 
                                    font-family: Arial, sans-serif; 
                                    margin: 20px; 
                                    background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
                                    min-height: 100vh;
                                    padding: 0;
                                }
                                .container {
                                    background: white;
                                    border-radius: 12px;
                                    padding: 30px;
                                    margin: 20px;
                                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                                }
                                .header { 
                                    color: #1976d2; 
                                    border-bottom: 2px solid #1976d2; 
                                    padding-bottom: 10px; 
                                    margin-bottom: 20px;
                                    font-size: 24px;
                                    font-weight: bold;
                                }
                                .subject { 
                                    background: #f8f9fa; 
                                    padding: 15px; 
                                    border-left: 4px solid #1976d2; 
                                    margin-bottom: 20px; 
                                    font-weight: bold;
                                    border-radius: 0 8px 8px 0;
                                }
                                .body { 
                                    line-height: 1.6; 
                                    white-space: pre-wrap; 
                                }
                                .footer { 
                                    margin-top: 30px; 
                                    padding-top: 20px; 
                                    border-top: 1px solid #e9ecef; 
                                    color: #6c757d; 
                                    font-size: 14px; 
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header">📧 Email Template Preview</div>
                                <div class="subject">Subject: ${previewSubject}</div>
                                <div class="body">${previewBody}</div>
                                <div class="footer">
                                    <strong>Template:</strong> ${name}<br>
                                    <strong>Preview generated:</strong> ${new Date().toLocaleString()}<br>
                                    <em>This is a preview using sample data. Actual emails will use real company information.</em>
                                </div>
                            </div>
                        </body>
                        </html>
                    `);
                    previewWindow.document.close();
                } catch (error) {
                    console.error('Error generating template preview:', error);
                    alert('Error generating preview. Please check your template syntax.');
                }
            });

            // Event delegation for dropdown options in milestones
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('email-templates-option')) {
                    e.preventDefault();
                    const companyId = parseInt(e.target.dataset.companyId);
                    const milestoneId = parseInt(e.target.dataset.milestoneId);
                    const milestoneName = e.target.dataset.milestoneName;
                    showEmailTemplatesModal(companyId, milestoneId, milestoneName);
                }
                
                if (e.target.classList.contains('milestone-notes-option')) {
                    e.preventDefault();
                    const companyId = parseInt(e.target.dataset.companyId);
                    const milestoneId = parseInt(e.target.dataset.milestoneId);
                    const milestoneName = e.target.dataset.milestoneName;
                    openNotesModal(companyId, milestoneId, milestoneName);
                }
            });

            // Enhance template list with "use template" functionality
            document.addEventListener('click', function(e) {
                if (e.target.closest('.list-group-item') && e.target.closest('#templatesList')) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('emailTemplatesModal'));
                    if (modal && modal._currentContext) {
                        const templateElement = e.target.closest('.list-group-item');
                        const templateName = templateElement.querySelector('.fw-bold').textContent;
                        const template = emailTemplates.find(t => t.name === templateName);
                        
                        if (template && confirm(`Use "${template.name}" template to send email?`)) {
                            useTemplateForEmail(template, modal._currentContext.companyId, modal._currentContext.milestoneName);
                        }
                    }
                }
            });

            // Add event listener for Email Templates dropdown option
            console.log('Adding email templates event listener...');
            const emailTemplatesBtn = document.getElementById('openEmailTemplates');
            console.log('Email templates button found:', emailTemplatesBtn);
            if (emailTemplatesBtn) {
                emailTemplatesBtn.addEventListener('click', function(e) {
                    console.log('Email templates clicked!');
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('emailTemplatesModal'));
                    modal.show();
                    loadEmailTemplates();
                    populateMilestoneDropdown();
                    renderTemplatesList();
                });
            }

            // Open Internal Email Templates Modal
            console.log('Adding internal email templates event listener...');
            const internalEmailTemplatesBtn = document.getElementById('openInternalEmailTemplates');
            console.log('Internal email templates button found:', internalEmailTemplatesBtn);
            if (internalEmailTemplatesBtn) {
                internalEmailTemplatesBtn.addEventListener('click', function(e) {
                    console.log('Internal email templates clicked!');
                    e.preventDefault();
                    const modal = new bootstrap.Modal(document.getElementById('internalEmailTemplatesModal'));
                    modal.show();
                    loadInternalEmailTemplates();
                    populateInternalMilestoneDropdown();
                    renderInternalTemplatesList();
                });
            }
        });

        console.log('Script loaded!');
    </script>
</body>
</html>
